-- -- part 1 capture listings quality metrics - this is done as a weekly capture

-- drop table if exists P_awang_ops_T.prot_samp_1_base1;

-- CREATE TABLE  P_awang_ops_T.prot_samp_1_base1  AS

-- (select 
-- retail_year,
-- retail_week,
-- case when categ_lvl2_id in (20710, 69197, 185066) then 'Electronics' 
-- when meta_categ_id in (26395) then 'Lifestyle'
-- when categ_lvl2_id in (386, 238, 1202, 49019, 183446, 80546, 222, 11731, 1082, 767, 233, 2613, 1188, 1039, 11743, 19169, 2562, 2616, 436, 14737, 2631, 2624, 717, 16486, 61573,64808,92074, 246) then 'Home & Garden'
-- when categ_lvl3_id in (35000) then 'Home & Garden'
-- when categ_lvl3_id in (3244) then 'Parts & Accessories'
-- when categ_lvl2_id in (46576) then 'Parts & Accessories'
-- else bsns_vrtcl_name end as new_vertical, 

-- case
-- -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- -- Q3 Pro Trader Inv Prop 20/7/22 
-- -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- -- defined first due to overlap
-- when categ_lvl3_id in (4250,1059,93427,4251,169291,15724,3034) and a.seller_id in (749606652,2293694103,1622388726,1078517816,1856813382,1675702526,997065708,1162804167,2067951122,894890636,56441205,956712338,1348539215,1757932344,191246954,130767072,589584808,2399628920,2210493957,81989834,1104420930,1077956817,460349390,1349420883,1033169535,1757146242,1503677405,961348774,118945299,1682880937,308013168,1516114674,1041032362,1248242095,2218091781,2338634389,1866502025,42942236,498740624,1106029208,1597340320,1166818601,2015587990,2162779803,1496117551,1753381952,1575383513,1220266750,72501954)  then 'Protrader Pre-Loved'
-- when categ_lvl3_id in (93427,3034) and a.seller_id in (2407209595,345951232,841375365,1087077138,1579448114,594742277,1337360836,1156735193,502037733,1822238312,97654211,1279792063,2394388928,236769109,2404388895,1319829084,1311951839,2402074027,57637208,190640570,939261259,2362554515,1615283964,2212431295,100578750,2401534552,2218063338,2392114683,170197795,2392764969,2403729127,2110404836,1870993654,2397878198,902433898,2229939146,1041370741,504829495,2206839837,2374009272,2388138282,2392506629,1702921347,779612483,1764998535,1487854181,2130558165,1116140796,1043576467,2319487417,1084443813,1330257361,2086025813,1397384139,9921989,1979842360,2412403027,1873729783,1396992496,930081697,114749585,1625091928,944564631,2411939171,673291958,2034362233,1153095139,1698367827,1456495330,855533213,1187728583,1180847104,1129053078,2379410309,804061756,221134935,1550157301,1233561601,1773902988,1171583855,2356636230,2410365911,1586278885,2400576456,306804503,1296853448,1122669470,2409469520,2374814275,1415417245,1024114570)  then 'Protrader Luxury Sneakers'
-- when categ_lvl3_id in (4250,93427,260325,169291,3034) and a.seller_id in (46985308,1062541899,1044209445,41421162,1007729348,1216039659,699890489,1798757044,1123656737,56696976,756158794,1314045480,1018868549,144630961,1749453942,1668870720,216411815,130067954,1202603417,1069883169,222783369,1317153690,109486490,1298531266,2344395620,2362571477,63019472,486619000,325374982,1174275765,288655014,1503867999,1050275365,1275779782,648357984,1768136482,1162684051,2406433129,1142797381,1805068928,62308769,1133200523,31885123,2351766326,1120406464,74494613,1086874666,44672077,1178372338,209737490,1584345847,1193523886,1020885052,1669034850,1138703637,1088471505,1936180706,224523539,52519830,134304482,803563110,780006191,39278781,1601299011,1380293356,2353351128,2416797447,1149473447,1544117255,1150021366,1813879333,649354544,1592670226,92761721,1355250729,192454687,1516330637,1424085858,1110394668,1876007900,1054523089,91059222,1164609059,1065976034,184841304,1410674601,204116991,57840841,1502881013,2399009731,55636349,162432303,146732626,1217583307,56095475,1099495376,1155940152,1421389290,2395107061,582105984,1208056498,38990840,1297566056,132320007,480992494,2110255131,15527484,1123408006,1112551970,189327845,216181635,1132432833,985965288,1000315992,1734319175,287838529,2385399896,191262728,1199136897,38557418,116418125,1287203887,365735231,170339741,2370235660,87217494,2298407919,967042915,1052081033,1206067863,884786058,1010317466,1608916559,1196059765,1307586654,2041395638,199494040,1565333127,193399590,10020303,1074635592,1241180667,917193540,1034462370,646712244,1458178587,2111047066,2174082402,118378913,2295981780,1231362947,861998596,1404586078,180827173,132952595)  then 'Protrader Luxury Watches & Handbags'
-- when categ_lvl2_id in (20710) or categ_lvl3_id in (185114,260508,80077,11071,168058,14990,48647,111694,112529,72406) then 'Protrader Appliances, TV & Audio'
-- when categ_lvl2_id in (165,31530,54968,171485,171957,171961,175672,175673,183062) and categ_lvl3_id in (167,169,31509,39976,131542,158816,158817,175671,182085,80183,49230,117042,117044,117045,171668,171813,171814,171820,171821,171826,171831,171837,171839,171858,171898,172510,182179,182180,171485,179,111418,1245,11195,11205,182086,177,111422,164,1244,3761,16145,27386,42000,42017,44980,131511,168059,170083,175674,182089,182090,183063) then 'Protrader Computing & Tablets'
-- when categ_lvl2_id in (360,28009) or categ_lvl3_id in (12,358,1212,1213,1214,4175,4176,20087,20088,63548,112090,2204,4170,4171,4172,4173,1207,4708,4771,37910,37912,37913,37914,37915,37917,37918,63516,63518,63519,63520,66637,100901,112084,121472,167948,2194,20085,37919,37934,60209,79947,116556,63589,162913,171166,261252,261255,261256,261257,261258,261259,261260,261261,261262,261263,261264,261265,261266,261267,261581,261584,261585,261586,261587,261754,361,1210,20095,2212,2213,22422,23048,1219,37942,37943,37944,60330,66850,66851,79948,79949,108816,108817,112159,112160,37964,63595,98448,98450,98452,98454,98462,98464,98466,98468,151725,179654,184438,184439,37978,66638,73469,37975,37976,37977,156320,156322,181727,261588,163102,163104,163105,262385,262386,262387,262388,262389,262390,262391,262392,262393,262394,262395,262396,262397,262398,262399,262400,262401,262402,262403,262404,262405,262406,262407,262408) then 'Protrader Antiques Pottery & Glass'
-- when categ_lvl3_id in (9886,33542,33549,33559,33579,33605,33612,33637,33687,33694,33726,99192) and a.cndtn_rollup_id = 1 then 'Protrader Car Parts'
-- when categ_lvl3_id in (9886,33542,33549,33559,33579,33605,33612,33637,33687,33694,33726,99192) and a.cndtn_rollup_id = 3 then 'Protrader Used Car Parts' 
-- when META_CATEG_ID in (9800,131090) and categ_lvl3_id in (14766,14767,27372,107060,107066,133187,133191,133192,133196,133201,133208,171112,173653,173668,175607,180370,180376,180386,180425) then 'Protrader Car Tuning & Styling'
-- when categ_lvl3_id in (3199,20480,20487,20488,20490,22653,32254,32878,34386,38199,38204,38208,48319,54235,88057,103430,103431,107578,114397,115753,125085,131579,166365,175754,179690,183320,183322,260157) then 'Protrader Furniture'
-- when META_CATEG_ID in (11700) and categ_lvl2_id in (299,14308) then 'Protrader Grocery'
-- when categ_lvl2_id in (11778,180345) then 'Protrader Health & Beauty'
-- when META_CATEG_ID in (11700) and CATEG_LVL2_ID in (10033) then 'Protrader Home Decor'
-- when CATEG_LVL2_ID in (38635) or CATEG_LVL3_ID in (179443,183745) then 'Protrader In Car Tech, Workshop Equipment, Vehicle Storage'
-- when CATEG_LVL3_ID in (3984,33346,99961,144062,151093,259103,259106,259113,259114,259115,259116,259127,1105,280,309,381,617,618,201,18839,18854,35029,61085,431,2328,2335,2375,29875,42437,53250,53251,58698,58707,58717,91500,29223,29792,41676,45113,45114,48831,120869,162028,52473,52554,63821,118254,377,180248,176983,176984,176985,279,1105,11442,69496,171223,171273,261186) then 'Protrader Media'
-- when categ_lvl3_id in (170135,183436,261328,261329,261330,261331,261332,261333,261334,261335,261893,262055,430,2535,183454,183455,183456,183457,183458,183459,183460,261041,261044,261045,2885,21544,27393,53599,53600,53606,53614,53615,53618,53619,53620,68283,68286,68287,68289,68294,68295,68296,68297,68298,68302,91574,97089,101736,101738,101739,101740,101741,101742,101743,101749,101750,101751,101752,101753,10072,21551,21552,21553,68374,206,2832,27277,27278,68348,68349,780,2833,27284,27285,68361,90894,788,106574,106575,106576,106577,106578,106579,106580,106581,106582,106583,106584,106585,112968,112969,112970,182399,2853,27358,27360,53623,68350,68355,68356,68357,101735,107438,112971,123711,1227,2830,27272,27273,31634,31635,428,1223,25548,27282,53650,68358,68359,101724,106550,113005,429,27403,27405,27406,31666,68360,75694,101725,106551,113006,2845,2902,31678,31679,43367,53660,68375,68376,68377,10366,106485,112972,112979,112992,123733,179234,6091,68311,68317,68322,68329,68334,68340,68341,72558,90887,101744,106534,106552,106559,106566,2880,53655,68369,68370,68371,75695,101759,101760,113008,123781,2839,2881,53658,68372,68373,75701,101761,101762,113009,113010,123782,2875,19293,27394,27410,46156,68367,68368,101755,113007,123770,203,2846,2855,2858,2867,2884,2892,2895,2897,24410,24442,72564,86984,101756,101757,101758,106586,9047,114299,165991,180339,262301,262045,262046,262047,262048,262049,262354,262355) then 'Protrader Memorabilia'
-- when meta_categ_id in (11450) and categ_lvl2_id in (260012) then 'Protrader Mens Clothing'
-- when categ_lvl2_id in (9355,178893) or categ_lvl3_id in (123417,123422) then 'Protrader Mobiles'
-- when categ_lvl2_id in (25298,26221) then 'Protrader Office Supplies & Material Handling'
-- when categ_lvl2_id in (1513,16034) then 'Protrader Sporting Goods'
-- when categ_lvl3_id in (73252,97093,171127,171138,177918,180268,180269,180273,180274,180275,180276,180277,180278,234,2540,2550,7317,22150,36275,40852,55415,80547,90922,123859,180350,230,2600,68386,68387,68394,30,229,719,727,736,2662,2663,11739,19019,19024,19180,58799,75725,113041,117217,123854,767,1039,1082,1189,262319,262320,262321,262322,262323,262324,262325,262326,262327,262335,34054,84912,168247,168248,171145,182181,182187,2615,19183,19186,19187,19188,776,4779,7319,73260,73262,73263,73265,137902,734,19214,56369,56370,68410,73266,80551,80553,91594,123850,123851,123852,123853,2518,11732,11733,11734,11735,11736,11737,44005,61113,61114,184588,11742,11744,11745,11746,16515,19017,61116,73257,101767,106631,109247,113040,117210,117211,117212,117213,117214,117215,117216,123844,133709,137885,137891,137894,137897,145845,181055,181056,14737,2537,2543,31398,44001,44012,45361,56363,91596,117218,123860,123871,145867,374,1197,2529,2574,2576,2646,19181,19854,56366,56367,106605,109232,145860,158746,168818,437,439,441,1036,1522,1628,1633,1634,7111,16479,19205,49020,80546,183447,263016) then 'Protrader Toys & Games' 
-- when categ_lvl2_id in (260010) then 'Protrader Womens Fashion'

-- else 'OTHERS' 
-- end as inventory_prop,


-- meta_categ_id,
-- categ_lvl2_id,
-- categ_lvl3_id,
-- categ_lvl3_name,
-- a.seller_id,
-- slr_categ_ll_cnt,
-- OD_slr_L3_ELL_CNT,
-- OD_SLR_LL_TO_GOAL_CNT,
-- MB_SLR_L3_ELL_CNT,
-- MB_SLR_LL_TO_GOAL_CNT,
-- SE_SLR_L3_LL_ALL_PCT *slr_categ_ll_cnt as SE_SLR_L3_ELL_CNT,
-- SE_SLR_LL_TO_Goal_CNT,
-- PL_SLR_L3_ELL_CNT,
-- PL_SLR_LL_TO_Goal_CNT,
-- SLR_lvl3_watchers_CNT,
-- FNF_SLR_L3_LL_PCT*slr_categ_ll_cnt/100 as FNF_SLR_L3_ELL_CNT,
-- FNF_SLR_LL_TO_Goal_CNT,
-- NDD_SLR_L3_LL_PCT*slr_categ_ll_cnt/100 as NDD_SLR_L3_ELL_CNT,
-- NDD_SLR_LL_TO_Goal_CNT,
-- DR_30_SLR_L3_LL_PCT*slr_categ_ll_cnt/100 as DR_30_SLR_L3_ELL_CNT,
-- DR_30_SLR_LL_TO_Goal_CNT,
-- CC_SLR_L3_LL*slr_categ_ll_cnt/100 as CC_SLR_L3_ELL_CNT,
-- CC_SLR_LL_TO_Goal_CNT
-- from P_MDALL_T.SLR_LVL3_CAT_DTL a -- this table refreshed on a weekly basis capture up to L3 level, from HIVE team
-- left outer JOIN ACCESS_VIEWS.DW_CAL_DT AS CAL
-- ON CAL.CAL_DT = a.cal_dt
-- /*inner join P_awang_opt_T.protrader_2021_Q2 s -- this is the table contain protrader sellers - replace this with seller you need to track
-- on a.seller_id = s.user_id */
-- );





-- drop table  if exists P_awang_ops_T.prot_samp_1_base2;
-- CREATE TABLE  P_awang_ops_T.prot_samp_1_base2  AS
-- (select a.*,
-- meta_categ_name,
-- categ_lvl2_name
-- from P_awang_ops_T.prot_samp_1_base1 a

--     INNER JOIN ( select meta_categ_id, meta_categ_name, count(*) as entries  from ACCESS_VIEWS.DW_CATEGORY_GROUPINGS where site_id = 3 group by 1,2 
--  qualify ROW_NUMBER() over  ( partition by  meta_categ_id order by entries desc) = 1
--  )  AS CAT
--         ON a.meta_categ_id = cat.meta_categ_id
		
--       INNER JOIN ( select categ_lvl2_id, categ_lvl2_name, count(*) as entries  from ACCESS_VIEWS.DW_CATEGORY_GROUPINGS where site_id = 3 group by 1,2 
--  qualify ROW_NUMBER() over  ( partition by  categ_lvl2_id order by entries desc) = 1
--  )  AS CATa
--         ON a.categ_lvl2_id = cata.categ_lvl2_id
		
-- 		 INNER JOIN ( select categ_lvl3_id, categ_lvl3_name, count(*) as entries  from ACCESS_VIEWS.DW_CATEGORY_GROUPINGS where site_id = 3 group by 1,2 
--  qualify ROW_NUMBER() over  ( partition by  CATEG_LVL3_id order by entries desc) = 1
--  )  AS CATaa
--         ON a.categ_lvl3_id = cataa.categ_lvl3_id
-- 		);



-- drop table P_awang_ops_T.prot_samp_1_gmv;
-- CREATE TABLE  P_awang_ops_T.prot_samp_1_gmv  AS
-- (SELECT
-- RETAIL_YEAR,
-- retail_week,
-- categ_lvl3_id,
-- ck.seller_id,
-- SUM(CK.QUANTITY) AS BI
--     ,SUM(CAST(CK.QUANTITY AS DECIMAL(18,2))* CAST(CK.ITEM_PRICE AS DECIMAL(18,2))*CAST(SSA.CURNCY_PLAN_RATE AS DECIMAL(18,2))) AS GMV
--    FROM  DW_CHECKOUT_TRANS ck 
--     INNER JOIN ( select CURNCY_PLAN_RATE,CURNCY_ID from  ACCESS_VIEWS.SSA_CURNCY_PLAN_RATE_DIM group by 1,2)AS SSA 
--         ON SSA.CURNCY_ID = CK.LSTG_CURNCY_ID     
        
--     INNER JOIN ( select meta_categ_id, CATEG_LVL2_ID, categ_lvl2_name, categ_lvl3_name, categ_lvl3_id,LEAF_CATEG_ID,SITE_ID,BSNS_VRTCL_NAME   from ACCESS_VIEWS.DW_CATEGORY_GROUPINGS where site_id = 3 group by 1,2,3,4,5,6,7,8 )  AS CAT
--         ON CK.LEAF_CATEG_ID = CAT.LEAF_CATEG_ID
--         AND CK.SITE_ID = CAT.SITE_ID

        
--     INNER JOIN ACCESS_VIEWS.DW_CAL_DT AS CAL
--         ON CAL.CAL_DT = CK.CREATED_DT
--         AND CAL.RETAIL_YEAR in (2022) and age_for_rtl_week_id = -1 
        
-- inner join  (select seller_id from P_awang_ops_T.prot_samp_1_base1 group by 1) fs
-- on ck.seller_id = fs.seller_id
--     WHERE 1=1
-- and  SLR_CNTRY_ID = 3 --UK sellers
-- and ck.site_id = 3 
-- AND RPRTD_WACKO_YN = 'N'
--         AND AUCT_END_DT >= '2017-12-20'
--         AND CREATED_DT >= '2017-12-20'     
--     GROUP BY 1,2,3,4);
	
-- 	drop table P_awang_ops_T.prot_samp_1_foutput;
-- CREATE TABLE  P_awang_ops_T.prot_samp_1_foutput AS
-- (select a.*,
-- b.retail_year as GMV_retail_year,
-- b.retail_week as GMV_retail_week,
-- GMV,
-- BI

-- from P_awang_ops_T.prot_samp_1_base2 a

-- left outer join P_awang_ops_T.prot_samp_1_gmv b
-- on a.seller_id = b.seller_id
-- and a.categ_lvl3_id = b.categ_lvl3_id);

-- -- GMV part actually redundent in this data pull, as for part 2 we decide to pull GMV directly

-- 	drop table if exists P_awang_ops_T.prot_samp_1_foutput2;
-- CREATE TABLE  P_awang_ops_T.prot_samp_1_foutput2 AS
-- (select 
-- retail_year,
-- retail_week,
-- case when GMV_retail_year is null then retail_year else GMV_retail_year end as retail_year_GMV,
-- case when GMV_retail_week is null then 6 else GMV_retail_week end as retail_week_GMV,
-- new_vertical,
-- meta_categ_id,
-- meta_categ_name,
-- categ_lvl2_id,
-- categ_lvl2_name,
-- categ_lvl3_id,
-- categ_lvl3_name,
-- INVENTORY_PROP,
-- seller_id,
-- user_slctd_id,
-- SLR_CATEG_LL_CNT as total_listing_cnt,
-- OD_SLR_L3_ELL_CNT as OD_listing_cnt,
-- OD_SLR_LL_TO_GOAL_CNT as OD_listing_goal,
-- MB_SLR_L3_ELL_CNT as MB_listing_cnt,
-- MB_SLR_LL_TO_GOAL_CNT as MB_listing_goal,
-- SE_SLR_L3_ELL_CNT as SE_listing_cnt,
-- SE_SLR_LL_TO_GOAL_CNT as SE_listing_goal,
-- PL_SLR_L3_ELL_CNT as PL_listing_cnt,
-- PL_SLR_LL_TO_GOAL_CNT as PL_listing_goal,
-- SLR_LVL3_WATCHERS_CNT as no_of_watchers,
-- FNF_SLR_L3_ELL_CNT as fast_Free_LL_CNT,
-- FNF_SLR_LL_TO_GOAL_CNT as fast_free_LL_goal,
-- NDD_SLR_L3_ELL_CNT as Next_Day_delivery_ll_cnt,
-- NDD_SLR_LL_TO_GOAL_CNT as Next_day_delivery_goal,
-- DR_30_SLR_L3_ELL_CNT as Day_30_return_LL_cnt,
-- DR_30_SLR_LL_TO_GOAL_CNT as Day_30_return_goal,
-- CC_SLR_L3_ELL_CNT as click_collect_cnt,
-- CC_SLR_LL_TO_GOAL_CNT as click_collect_goal,
-- (GMV) as gmv,
-- (BI) as BI
-- from P_awang_ops_T.prot_samp_1_foutput f
-- inner join dw_users u on f.seller_id = u.user_id);

-- 	drop table if exists P_awang_ops_T.prot_samp_1_sellerst;
-- CREATE TABLE  P_awang_ops_T.prot_samp_1_sellerst AS
-- (select 
-- a.seller_id,
-- CASE WHEN SPS.SPS_SLR_LEVEL_CD = 1 THEN 'eTRS' WHEN SPS.SPS_SLR_LEVEL_CD = 2 THEN 'Above Standard' WHEN SPS.SPS_SLR_LEVEL_CD = 3 THEN 'Standard' WHEN SPS.SPS_SLR_LEVEL_CD = 4 THEN 'Below Standard' ELSE 'No seller standard'END AS SELLER_STANDARD
-- from
-- (select seller_idP_awang_ops_T.prot_samp_1_sellerst
-- from P_awang_ops_T.prot_samp_1_foutput2
-- group by 1) a 
        
-- LEFT JOIN (select USER_ID,
-- SPS_SLR_LEVEL_CD, 
-- last_eval_Dt from  PRS_RESTRICTED_V.SPS_LEVEL_METRIC_SUM X 
-- where SPS_EVAL_TYPE_CD = 1 AND SPS_PRGRM_ID = 3 group by 1,2,3 qualify (row_number() over (partition by user_id order by last_eval_Dt desc))=1) SPS
-- ON a.seller_id = sps.user_id) ;

-- -- part 2 GMV only - no need for weekly insert, can run restrospective data

drop table if exists P_awang_opt_T.prot_samp_1_gmv2;
CREATE TABLE  P_awang_opt_T.prot_samp_1_gmv2 AS
(SELect
RETAIL_YEAR,
retail_week,
case when categ_lvl2_id in (20710, 69197, 185066) then 'Electronics' 
when meta_categ_id in (26395) then 'Lifestyle'
when CATEG_LVL3_ID in (260325) then 'Lifestyle'
when categ_lvl2_id in (386, 238, 1202, 49019, 183446, 80546, 222, 11731, 1082, 767, 233, 2613, 1188, 1039, 11743, 19169, 2562, 2616, 436, 14737, 2631, 2624, 717, 16486, 61573, 246) then 'Home & Garden'
when categ_lvl3_id in (35000, 98989) then 'Home & Garden'
when categ_lvl3_id in (3244) then 'Parts & Accessories'
when categ_lvl3_id in (124982, 259225,180969, 260509) then 'Business & Industrial'
when categ_lvl2_id in (46576) then 'Parts & Accessories'
when categ_lvl2_id in (63, 29223) then 'Collectibles'
else bsns_vrtcl_name end as new_vertical, 
--B.seller_id as focused_seller_id,


case
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Q4 Pro Trader Inv Prop 12/10/22
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- defined first due to overlap
 when cat.meta_categ_id in (11450) and ck.seller_id in (307192177,1481012857,1757932344,1575383513,2210493957,773995006,1023588063,1199345580,82480562,237808021,706753239,1145963029,2267515823,1983590617,1552952019,2015587990,844787885,757526432,87068066
 ,130747977,684628835,66003839,162019022,1956225193,100120501,1502778521,1376647487,1138703637,779492056,189495802,130767072,137956699,1043622463,1734496887,1503677405,876399046,2139893858,2192741079,1348539215,1207090376,1069427042,1857209412,1472932493
 ,2008064034,241885773,47767499,127958869,1437288465,895658187,1596600617,925364946,2190598554,2321191974,2140414117,568770265,2045937738,1064517454,727996431,56441205,72501954,303794277,1149724322,2188685622,1204012898,708929217,1583019209,1453078921
 ,100975179,1376647487,1018004872,1615320668,932543695,1956225193,1020106378,1155838452,112626381,986620253,1792187227,838615039,2347959432,32373220,1010737404,406522972,795067569,731894315,1444763902,1189377898,1121792323,1072903166,1682970496,641945991
 ,1106802271,105877760,1566788720,200219208,67202535,1175821415,101106197,2306346724,182008565,181814486,136081930,1755118947,1086795106,1150021366,1166115664,693211033,1156547993,731522388,1942371356,1045472445,162848198,238071968,1711911003,43174093
 ,1166899945,67186775,1276697773,1481012857,2357566726,2388675071,168710399,1123656737,385712396,1415854000,155155735,74749887,24285743,1118217715,2090743468,1487854181,2401534552,589584808,2067951122,1094492781,2416797447,1022818305,1593421075,1593208052
 ,2364515191,1808450679,370085063,1594935262,1127480607,1278754749,64457901,460349390,1838268376,2281149511,1070682084,1629110227,449110946,1853894023,894890636,693211033,106008194,1959627728,945168871,1983590617,236365990,1160961108,749606652,2364515191
 ,71923414,1069090918,1125163357,1487198031,1402205790,1562312075,1157133803,1263331260,1018868549,1179776256,787759223,775905101,2042716022)  then 'Pro Trader Pre-Loved'
 when (cat.categ_lvl3_id in (95672, 15709, 155202, 57974, 57929,169291) or cat.categ_lvl4_id in (52357)) and ck.seller_id in (1835540051,1216039659,803563110,1054523089,2416797447,1813879333,1150021366,127004873,1599568314,1599083503,118945299,1380293356
 ,1601299011,814070408,486619000,509007270,1123656737,1138703637,1062541899,305587902,2086661886,359013244,1132432833,1415854000,1193523886,1485357533,1199136897,1274406447,1155940152,1876007900,62308769,780006191,174580477,1065976034,60917492,1148091153
 ,1822238312,1279792063,2394388928,236769109,2404388895,2401534552,1043576467,1084443813,1397384139,930081697,2034362233,855533213,1550157301,2410365911,1183218560,1009683250,1479069056,1055061407,1034142459,1776126306,768627758,1043109755,2231234088
 ,1555901602,1487854181,2210447448,1234196568,221134935,779612483,2048417966,190640570,2184731408,594742277,1547326162,1070857520,306804503,182186079,2110404836,1122669470,1281178189,141590080,2130558165,1473902414,100578750,460349390,1615283964,2212431295
 ,605853908,1330257361,669471442,1127480607,1278791524,1087077138,1093603614,1456495330,163749451,1319829084,1041370741,1302242738,2105251860,1478551076,1024114570,1123835148,114749585,1275379491,939261259,128319745,1337360836,750406513,2157041305,1800758596
 ,1322507086,1586278885,944564631,1993057449,1552208426,915563161,1437437796,1129053078,97476529,1870993654,2218063338,1764998535,1855727464,1322602121,673291958,2216664379,1156735193,804061756,124729887,134271887,138458180,9921989,1806980823)  then 'Pro Trader Luxury Handbags & Sneakers'
 when cat.meta_categ_id in (281) and ck.seller_id in (192376191,1193156083,1070085146,1088325962,1706309114,2076849914,108561220,411947125,2217699786,1592686816,1124299881,230389293,314987822,1038378555,1028037130,1906970499,986591370,1000243998,1397020813,1129210695,136955991,1106715478,300222646,1157577152,2153237029,94324923,2221096629,2001384536,2264039823,1153191840,758892726,1178372338,325374982,1120406464,1669034850,1516330637,38557418,1565333127,2295981780,1231362947,1840715311,1088471505,1404586078,1913277462,162432303,1086874666,1241180667,56696976,130067954,1069883169,63019472,1174275765,134304482,57840841,1502881013,2399009731,55636349,146732626,2395107061,38990840,191262728,87217494,2298407919,1010317466,1608916559,193399590,10020303,646712244,2174082402,861998596,2353351128)  then 'Pro Trader Luxury Jewellery & Watches'

when cat.meta_categ_id in (1,220,267,1,64482) and (cat.categ_lvl2_id in (246,63,180250) or cat.categ_lvl3_id in (183454,261332,261328)) then 'Pro Trader Memorabilla'
when cat.meta_categ_id in (550) and cat.categ_lvl2_id in (360,28009) then 'Pro Trader Art, Print & Coins'
when cat.meta_categ_id in (58058) and (cat.categ_lvl2_id in (175672,171957,171961,171961,182094,171485,175673,162497,31530,3676) or cat.categ_lvl3_id in (178893,9355,1245,11195,171485)) and cndtn_rollup_id in (2) then 'Pro Trader Refurbished Technology'
when cat.meta_categ_id in (58058) and (cat.categ_lvl2_id in (175672,171957,171961,171961,182094,171485,175673,162497,31530,3676) or cat.categ_lvl3_id in (178893,9355,1245,11195,171485)) and item_cndtn_id in (1000) then 'Pro Trader New Technology'
when cat.categ_lvl2_id in (261186,617,176985,176984) then 'Pro Trader Media'
when (cat.meta_categ_id in (20710) or cat.categ_lvl3_id in (32852,14961,14969,11071,15052,260307,43563,20667,71258,42231,45733,42231,38250)) and item_cndtn_id in (1500) then 'Pro Trader Consumer Electronics'
when cat.categ_lvl2_id in (48757,260018) then 'Pro Trader Baby Products'
when cat.meta_categ_id in (11450) and cat.categ_lvl2_id in (260012) then 'Pro Trader Men & Womens Fashion'
when cat.meta_categ_id in (11450) and cat.categ_lvl2_id in (260010) then 'Pro Trader Men & Womens Fashion'
when cat.meta_categ_id in (11450) and cat.categ_lvl2_id in (171146) then 'Pro Trader Kids & Specialty Clothing'
when cat.meta_categ_id in (11450) and cat.categ_lvl2_id in (260033) and cat.categ_lvl3_id in (163147,312,175759,3259) then 'Pro Trader Kids & Specialty Clothing'
when cat.meta_categ_id in (888) and cat.categ_lvl2_id in (1513,15273) then 'Pro Trader Sporting Goods'
when cat.meta_categ_id in (26395) and cat.categ_lvl2_id in (180345,11778) then 'Pro Trader Beauty & Medical Products'
when cat.categ_lvl3_id in (170090,170115,170098,102378) then 'Pro Trader Christmas 2022'
when cat.meta_categ_id in (11700,11701) and cat.categ_lvl2_id in (10033,20571,20697,16086) and cat.categ_lvl3_id in (79654,20563,31587,46782,159889,20580,20552,4959,20549,38237,36025,10034,16102,125072,101415,41510,36022,38225,31601,41511
,36017,36019,20551,20569,36016,38235,31586,20578,36018,36023,41509,74316,31588,45510,20574,91421,262982,37978,20708,112581,116022,116880,117503,170090)  then 'Pro Trader Home Decor'
when cat.meta_categ_id in (11700) and cat.categ_lvl2_id in (3197) and cat.categ_lvl3_id in (179690,22653,131579,183320,260157,34386,166365,32254,38208,38204,54235,20487,103430,3199,107578,114397,20488,88057,183322,20480,103431,38199,20490
,32878,48319,175754,175752,125085,115753) then 'Pro Trader Furniture'
when cat.meta_categ_id in (220) and cat.categ_lvl2_id in (222,233,436,717,767,1039,1082,1188,2562,2613,2616,2624,2631,11731,11743,14737,16486,19169,49019,80546,183446) and cat.categ_lvl3_id in (30,229,230,234,374,437,439,441,719,727,734,736,767
,774,776,1036,1039,1082,1189,1197,1522,1628,1633,1634,2518,2529,2537,2540,2543,2550,2574,2576,2594,2595,2600,2615,2624,2646,2662,2663,4779,7111,7317,7319,11732,11733,11734,11735,11736,11737,11739,11742,11744,11745,11746,14737,16479,16515
,19001,19017,19019,19024,19180,19181,19183,19186,19187,19188,19205,19214,19854,21254,22150,31398,34054,36275,40852,44001,44005,44012,45361,49020,50296,52338,55415,56363,56366,56367,56369,56370,58799,61113,61114,61116,68386,68387,68394,68410
,70109,73252,73257,73260,73262,73263,73265,73266,75725,80546,80547,80551,80553,84912,90922,91594,91596,97093,101767,106605,106631,109232,109247,113040,113041,117210,117211,117212,117213,117214,117215,117216,117217,117218,123844,123850,123851
,123852,123853,123854,123859,123860,123871,133709,137885,137891,137894,137897,137902,145845,145860,145867,158746,168247,168248,168818,171127,171138,171145,177918,180023,180268,180269,180273,180274,180275,180276,180277,180278,180350,181055
,181056,182181,182187,183447,184588,258040,258041) then 'Pro Trader Toys & Games'
when (cat.meta_categ_id in (131090) and cat.categ_lvl2_id in (6030) and cat.categ_lvl3_id in (33549,33612,33726,33637,33687,33605,33579,9886,33559,33694,33542)) and cndtn_rollup_id in (1) then 'Pro Trader New Car Parts'
when (cat.meta_categ_id in (131090) and cat.categ_lvl2_id in (6030) and cat.categ_lvl3_id in (33549,33612,33726,33637,33687,33605,33579,9886,33559,33694,33542)) and cndtn_rollup_id in (3) then 'Pro Trader Used Car Parts'
when cat.meta_categ_id in (131090) and cat.categ_lvl2_id in (38635,34998) and cat.categ_lvl3_id in (179672,169321,171101,169423,138854,185012,139835,96370,14262,183745,179443) then 'Pro Trader In Car Tech, Workshop Equipment, Vehicle Storage'
when cat.meta_categ_id in (131090) and cat.categ_lvl2_id in (107059) and cat.categ_lvl3_id in (107066,180370,133192,175607,133196,171112,133191,133208,180425,173668,180386,173653,133187,133201,107060,180376) then 'Pro Trader Car Tuning & Styling'
when cat.meta_categ_id in (12576) and cat.categ_lvl2_id in (25298,26221) and cat.categ_lvl3_id in (302,1304,11828,19273,25301,25307,25319,26220,26224,31485,50203,50204,57004,61673,92079,109551,184149,184161,184165,184174,184227,260910) then 'Pro Trader Office Supplies & Material Handling'
when cat.meta_categ_id in (11700) and cat.categ_lvl2_id in (299,14308) and cat.categ_lvl3_id in (257942,259345,259621,185035,259338,20620,106121,79631,300,179836,258026,62706,62694) then 'Pro Trader Grocery'


else 'OTHERS' 
end as inventory_prop,
meta_categ_name,
meta_categ_id,
categ_lvl2_id,
categ_lvl2_name,
categ_lvl3_id,
categ_lvl3_name,
ck.seller_id,
SUM(CK.QUANTITY) AS BI,
SUM(GMV_PLAN_USD) AS GMV
 
FROM  DW_CHECKOUT_TRANS ck 
INNER JOIN ( select CURNCY_ID, CURNCY_PLAN_RATE from  ACCESS_VIEWS.SSA_CURNCY_PLAN_RATE_DIM group by 1,2)AS SSA 
        ON SSA.CURNCY_ID = CK.LSTG_CURNCY_ID    
    INNER JOIN ( select meta_categ_id, meta_categ_name, CATEG_LVL2_ID, categ_lvl2_name, categ_lvl3_name, categ_lvl3_id,categ_lvl4_id,LEAF_CATEG_ID,SITE_ID,BSNS_VRTCL_NAME  
	from ACCESS_VIEWS.DW_CATEGORY_GROUPINGS)  AS CAT
        ON CK.LEAF_CATEG_ID = CAT.LEAF_CATEG_ID
        AND CK.SITE_ID = CAT.SITE_ID

LEFT JOIN ( select ITEM_ID,item_cndtn_id, CNDTN_ROLLUP_ID from ACCESS_VIEWS.LSTG_ITEM_CNDTN group by 1,2,3 ) AS CNDTN
        ON CK.ITEM_ID = CNDTN.ITEM_ID
		
INNER JOIN ACCESS_VIEWS.DW_CAL_DT AS CAL
        ON CAL.CAL_DT = CK.CREATED_DT
        AND CAL.RETAIL_YEAR in (2021, 2022) and age_for_rtl_week_id <= -1 
        
inner join  (select user_id from P_awang_opt_T.protrader_2021_Q2 group by 1) fs on ck.seller_id = fs.user_id 

    WHERE 1=1
and  SLR_CNTRY_ID = 3 --UK sellers
and ck.site_id = 3 
AND RPRTD_WACKO_YN = 'N'
        AND AUCT_END_DT >= '2017-12-20'
        AND CREATED_DT >= '2017-12-20'     
    GROUP BY 1,2,3,4,5,6,7,8,9,10,11) ;
 
-- THIS IS THE FINAL TABLE IN THE REPORT***** 

drop table if exists P_awang_ops_t.prot_samp_1_gmv3;
CREATE TABLE  P_awang_ops_t.prot_samp_1_gmv3 AS
 
 (select 
retail_year,
retail_week,
new_vertical,
inventory_prop,
seller_id,
user_slctd_id,
sum(BI) as BI,
sum(GMV) as GMV

from P_awang_opt_T.prot_samp_1_gmv2 f
inner join dw_users u on f.seller_id = u.user_id

where inventory_prop <> 'OTHERS'

group by 1,2,3,4,5,6);

-- this is the weekly capture table - need to be updated to insert in subsquent weeks
/* select a.*,
SELLER_STANDARD
from P_awang_ops_T.prot_samp_1_foutput2 a
left outer join P_awang_ops_T.prot_samp_1_sellerst b
on a.seller_id = b.seller_id;

select retail_year,
retail_week from P_awang_ops_T.prot_samp_1_gmv3 group by 1,2
*/



