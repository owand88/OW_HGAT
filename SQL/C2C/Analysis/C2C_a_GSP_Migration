/**********************************************************************************************************************************************************
Jira: UKPLAN-456
Requestor: Ellen G (C2C)
Developer: Gabriella A
Description: Request to understand the potenital impact of the move from GSP to Eis. Most work has already been completed by IAC (Vinit), codes supplied by David (zhicliu). More info on wikis, pls see jira for links
**********************************************************************************************************************************************************/

-- GSP NEW LL --
SELECT
	LL.AUCT_START_DT
	,COALESCE(CASE 
				WHEN lstg.SELLER_SEGMENT_DETAIL = 'Regular' THEN 'Regular'
				WHEN lstg.SELLER_SEGMENT_DETAIL in ('Large Merchant', 'Merchant', 'Entrepreneur') THEN 'Entrepreneur'
				WHEN lstg.SELLER_SEGMENT_DETAIL = 'Occasional' THEN 'Occasional'
				WHEN lstg.SELLER_SEGMENT_DETAIL in ('UnsuccesfulLister','LapsedLister','FTL') THEN 'NORS'
				WHEN lstg.SELLER_SEGMENT_DETAIL in ('FTL') THEN 'New' 
				ELSE 'Other' END
				,'Total') as Segments
	,COUNT(*)  AS NEW_GSP_LL
	,COUNT(DISTINCT LL.SLR_ID) AS NEW_SLR_CNT

FROM 		ACCESS_VIEWS.DW_LSTG_ITEM LL

INNER JOIN  ACCESS_VIEWS.DW_CATEGORY_GROUPINGS CAT
ON  		LL.ITEM_SITE_ID = cat.SITE_ID
AND 		LL.LEAF_CATEG_ID = cat.LEAF_CATEG_ID
AND 		cat.SAP_CATEGORY_ID NOT IN (5,7,23,41,-999)

LEFT JOIN 	ACCESS_VIEWS.DW_USEGM_HIST HIST 
ON 			HIST.USER_ID = LL.SLR_ID 
AND 		HIST.USEGM_GRP_ID  = 48 
AND 		CASE WHEN LL.AUCT_START_DT < '2009-10-11' THEN CAST('2009-10-11' AS DATE) ELSE LL.AUCT_START_DT END BETWEEN HIST.BEG_DATE AND HIST.END_DATE  

INNER JOIN 	PRS_RESTRICTED_V.SLNG_LSTG_SUPER_FACT LSTG 
ON 			LL.ITEM_ID = LSTG.ITEM_ID
AND  		LL.AUCT_START_DT = LSTG.AUCT_START_DT

WHERE 		1=1
AND 		LL.GSP_ENABLED_FLAG = 1
AND 		LL.AUCT_TYPE_CODE NOT IN (10,12,15)   -- not half.com or shopping.com items
AND   		LL.ITEM_SITE_ID = 3
AND 		LL.SLR_CNTRY_ID = 3
AND  		LL.WACKO_YN = 'N'
AND 		LL.AUCT_START_DT BETWEEN  DATE_SUB(CURRENT_DATE,56) AND DATE_SUB(CURRENT_DATE,2)
AND 		LL.AUCT_END_DT >= DATE_SUB(CURRENT_DATE,90)
AND   		CASE WHEN HIST.USEGM_ID = 206 THEN 'B2C' ELSE 'C2C' END = 'C2C'

GROUP BY 	1, ROLLUP(CASE WHEN lstg.SELLER_SEGMENT_DETAIL = 'Regular' THEN 'Regular' WHEN lstg.SELLER_SEGMENT_DETAIL in ('Large Merchant', 'Merchant', 'Entrepreneur') THEN 'Entrepreneur'
										  WHEN lstg.SELLER_SEGMENT_DETAIL = 'Occasional' THEN 'Occasional' WHEN lstg.SELLER_SEGMENT_DETAIL in ('UnsuccesfulLister','LapsedLister','FTL') THEN 'NORS'
										  WHEN lstg.SELLER_SEGMENT_DETAIL in ('FTL') THEN 'New' ELSE 'Other' END)
ORDER BY 	1 DESC 
;



-- GSP TOTAL DAILY LL --
SELECT
	CAL.CAL_DT
	,COALESCE(CASE 
				WHEN lstg.SELLER_SEGMENT_DETAIL = 'Regular' THEN 'Regular'
				WHEN lstg.SELLER_SEGMENT_DETAIL in ('Large Merchant', 'Merchant', 'Entrepreneur') THEN 'Entrepreneur'
				WHEN lstg.SELLER_SEGMENT_DETAIL = 'Occasional' THEN 'Occasional'
				WHEN lstg.SELLER_SEGMENT_DETAIL in ('UnsuccesfulLister','LapsedLister','FTL') THEN 'NORS'
				WHEN lstg.SELLER_SEGMENT_DETAIL in ('FTL') THEN 'New' 
				ELSE 'Other' END
				,'Total') as Segments
	,COUNT(*)  AS TOT_LL
	,COUNT(DISTINCT LL.SLR_ID) AS SLR_CNT_LL
	,SUM(CASE WHEN LL.GSP_ENABLED_FLAG = 1 THEN 1 ELSE 0 END) AS TOT_GSP_LL
	,COUNT(DISTINCT CASE WHEN LL.GSP_ENABLED_FLAG = 1 THEN LL.SLR_ID END) AS SLR_CNT_GSP_LL

FROM 		ACCESS_VIEWS.DW_LSTG_ITEM LL

INNER JOIN  ACCESS_VIEWS.DW_CATEGORY_GROUPINGS CAT
ON  		LL.ITEM_SITE_ID = cat.SITE_ID
AND 		LL.LEAF_CATEG_ID = cat.LEAF_CATEG_ID
AND 		cat.SAP_CATEGORY_ID NOT IN (5,7,23,41,-999)

INNER JOIN 	ACCESS_VIEWS.DW_CAL_DT CAL
ON 			LL.AUCT_START_DT < CAL.CAL_DT 
AND   		LL.AUCT_END_DT >= CAL.CAL_DT

LEFT JOIN 	ACCESS_VIEWS.DW_USEGM_HIST HIST 
ON 			HIST.USER_ID = LL.SLR_ID 
AND 		HIST.USEGM_GRP_ID  = 48 
AND 		CASE WHEN LL.AUCT_START_DT < '2009-10-11' THEN CAST('2009-10-11' AS DATE) ELSE LL.AUCT_START_DT END BETWEEN HIST.BEG_DATE AND HIST.END_DATE  

INNER JOIN 	PRS_RESTRICTED_V.SLNG_LSTG_SUPER_FACT LSTG 
ON 			LL.ITEM_ID = LSTG.ITEM_ID
AND  		LL.AUCT_START_DT = LSTG.AUCT_START_DT

WHERE 		1=1
AND 		LL.AUCT_TYPE_CODE NOT IN (10,12,15)   
AND   		LL.ITEM_SITE_ID = 3
AND 		LL.SLR_CNTRY_ID = 3
AND  		LL.WACKO_YN = 'N'
AND 		CAL.AGE_FOR_RTL_WEEK_ID IN (-1,0)
AND 		CAL.CAL_DT <= CURRENT_DATE - 2
AND   		CASE WHEN HIST.USEGM_ID = 206 THEN 'B2C' ELSE 'C2C' END = 'C2C'

GROUP BY 	1 ,ROLLUP(CASE WHEN lstg.SELLER_SEGMENT_DETAIL = 'Regular' THEN 'Regular' WHEN lstg.SELLER_SEGMENT_DETAIL in ('Large Merchant', 'Merchant', 'Entrepreneur') THEN 'Entrepreneur'
						   WHEN lstg.SELLER_SEGMENT_DETAIL = 'Occasional' THEN 'Occasional' WHEN lstg.SELLER_SEGMENT_DETAIL in ('UnsuccesfulLister','LapsedLister','FTL') THEN 'NORS'
						   WHEN lstg.SELLER_SEGMENT_DETAIL in ('FTL') THEN 'New' ELSE 'Other' END)
ORDER BY 	1 DESC 
;


-- GSP GMV STATS --
SELECT
	CAL.CAL_DT
	,COALESCE(CASE 
				WHEN tran_sf.SELLER_SEGMENT_DETAIL = 'Regular' THEN 'Regular'
				WHEN tran_sf.SELLER_SEGMENT_DETAIL in ('Large Merchant', 'Merchant', 'Entrepreneur') THEN 'Entrepreneur'
				WHEN tran_sf.SELLER_SEGMENT_DETAIL = 'Occasional' THEN 'Occasional'
				WHEN tran_sf.SELLER_SEGMENT_DETAIL in ('UnsuccesfulLister','LapsedLister','FTL') THEN 'NORS'
				WHEN tran_sf.SELLER_SEGMENT_DETAIL in ('FTL') THEN 'New' 
				ELSE 'Other' END
				,'ALL') as Segments
	,SUM(CASE WHEN TRAN.SLR_CNTRY_ID = 3 AND TRAN.BYR_CNTRY_ID <> 3 THEN TRAN.ITEM_PRICE*TRAN.QUANTITY*CUR.CURNCY_PLAN_RATE ELSE 0 END) AS EXPORT_GMV
	,SUM(CASE WHEN (CAST(TRAN.CK_FLAGS6 AS INTEGER) & 256) <> 0 AND NVL(IDL.PSA_FLAG,0) <> 1 THEN TRAN.ITEM_PRICE*TRAN.QUANTITY*CUR.CURNCY_PLAN_RATE ELSE 0 END) AS GSP_GMV
	,GSP_GMV/EXPORT_GMV AS EXPORT_SHARE
	,SUM(CASE WHEN (CAST(TRAN.CK_FLAGS6 AS INTEGER) & 256) <> 0 AND NVL(IDL.PSA_FLAG,0) <> 1 THEN 1 ELSE 0 END) AS GSP_TXN_CNT
	,SUM(CASE WHEN (CAST(TRAN.CK_FLAGS6 AS INTEGER) & 256) <> 0 AND NVL(IDL.PSA_FLAG,0) <> 1 THEN TRAN.QUANTITY ELSE 0 END) AS GSP_SI
	,GSP_GMV/GSP_SI AS GSP_ASP

FROM 		ACCESS_VIEWS.DW_CHECKOUT_TRANS TRAN

INNER JOIN  ACCESS_VIEWS.DW_CATEGORY_GROUPINGS CAT
ON  		TRAN.SITE_ID = cat.SITE_ID
AND 		TRAN.LEAF_CATEG_ID = cat.LEAF_CATEG_ID
AND 		cat.SAP_CATEGORY_ID NOT IN (5,7,23,41,-999)

INNER JOIN 	ACCESS_VIEWS.DW_CAL_DT CAL
ON 			TRAN.CREATED_DT = CAL.CAL_DT

LEFT JOIN 	ACCESS_VIEWS.IDL_CHECKOUT_TRANS_FACT IDL
ON 			TRAN.ITEM_ID = IDL.ITEM_ID
AND 		TRAN.TRANSACTION_ID = IDL.TRXN_ID
AND 		IDL.CREATED_DT BETWEEN '2019-12-01' AND DATE_SUB(CURRENT_DATE,1)

INNER JOIN	ACCESS_VIEWS.SSA_CURNCY_PLAN_RATE_DIM AS CUR
ON  		CUR.CURNCY_ID = TRAN.LSTG_CURNCY_ID 
-- AND 		CUR.CURNCY_ID IN (1,3)

INNER JOIN  PRS_RESTRICTED_V.SLNG_TRANS_SUPER_FACT tran_sf
ON 			tran_sf.ITEM_ID = tran.ITEM_ID
AND 		tran_sf.TRANSACTION_ID = tran.TRANSACTION_ID

WHERE 		1=1
AND   		TRAN.SITE_ID = 3
AND  		TRAN.SLR_CNTRY_ID = 3
AND 		TRAN.SALE_TYPE NOT IN (10,12,15)
AND  		TRAN.CK_WACKO_YN = 'N'
AND 		CAL.AGE_FOR_RTL_WEEK_ID IN (-1,0)
AND  		CAL.CAL_DT <= CURRENT_DATE - 2
AND   		TRAN_SF.EU_B2C_C2C_FLAG = 'C2C'

GROUP BY 	1, ROLLUP(CASE WHEN TRAN_SF.SELLER_SEGMENT_DETAIL = 'Regular' THEN 'Regular' WHEN TRAN_SF.SELLER_SEGMENT_DETAIL in ('Large Merchant', 'Merchant', 'Entrepreneur') THEN 'Entrepreneur'
						   WHEN TRAN_SF.SELLER_SEGMENT_DETAIL = 'Occasional' THEN 'Occasional' WHEN TRAN_SF.SELLER_SEGMENT_DETAIL in ('UnsuccesfulLister','LapsedLister','FTL') THEN 'NORS'
						   WHEN TRAN_SF.SELLER_SEGMENT_DETAIL in ('FTL') THEN 'New' ELSE 'Other' END)
ORDER BY 	1 DESC 
;


-- DAILY NEW GSP SELLERS --
SELECT 
	DATE
	,COUNT(*) AS NEW_GSP_SELLERS

FROM (
		SELECT  
			ENRL.AGRMNT_ACPT_DT AS DATE
			,USR.USER_ID
		
		FROM 		DW_USERS AS USR

		INNER JOIN 	DW_USER_AGRMNT_LOG AS ENRL
		ON 			ENRL.USER_ID = USR.USER_ID 
		
		LEFT JOIN 	ACCESS_VIEWS.DW_USEGM_HIST HIST 
		ON 			HIST.USER_ID = USR.USER_ID
		AND 		HIST.USEGM_GRP_ID  = 48 
		AND 		ENRL.AGRMNT_ACPT_DT BETWEEN HIST.BEG_DATE AND HIST.END_DATE  
		
		WHERE  		1=1
		AND 		ENRL.SITE_ID IN (3) 
		AND 		ENRL.AGRMNT_ID = 8
		AND 		ENRL.AGRMNT_ACPT_IND = 1
		AND 		ENRL.AGRMNT_STS_CD = 1
		AND 		ENRL.AGRMNT_ACPT_DT BETWEEN DATE_SUB(CURRENT_DATE,56) AND DATE_SUB(CURRENT_DATE,1)
		AND   		CASE WHEN HIST.USEGM_ID = 206 THEN 'B2C' ELSE 'C2C' END = 'C2C'
		 
		GROUP BY 	1,2
	) 

GROUP BY 1
;











































