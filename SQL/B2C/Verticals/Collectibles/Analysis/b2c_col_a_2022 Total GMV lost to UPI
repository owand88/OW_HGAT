DROP TABLE IF EXISTS TEMP_GMB_UPI_2022;
CREATE TEMP TABLE TEMP_GMB_UPI_2022 AS (
SELECT
	cal.RETAIL_YEAR
	,tran.TRANSACTION_ID
	,tran.ISCORE
	,tran.PAID_IND
	,tran.CK_TRANS_DT
	,tran.GMV_DT
	,lstg.AUCT_START_DT
	,lstg.AUCT_END_DT
	,tran.ITEM_ID
	,cat.META_CATEG_ID
	,cat.META_CATEG_NAME
	,cat.CATEG_LVL2_ID
	,cat.CATEG_LVL2_NAME
	,cat.CATEG_LVL3_ID
	,cat.CATEG_LVL3_NAME
	,tran.EU_B2C_C2C_FLAG
	,tran.RPRTD_WACKO_YN
	,tran.GMV20_PLAN
	,tran.ITEM_PRICE_AMT
	,tran.QUANTITY
	,tran.LSTG_CURNCY_EXCHNG_RATE


FROM 		PRS_RESTRICTED_V.SLNG_TRANS_SUPER_FACT tran 

INNER JOIN 	PRS_RESTRICTED_V.SLNG_LSTG_SUPER_FACT lstg 
ON  		tran.ITEM_ID = lstg.ITEM_ID

INNER JOIN 	ACCESS_VIEWS.DW_CAL_DT cal 
ON 			cal.CAL_DT = tran.CK_TRANS_DT --> ck_trans_dt is the date of the transaction because gmv date will be null if unpaid 

INNER JOIN 	(SELECT * FROM ACCESS_VIEWS.DW_CATEGORY_GROUPINGS WHERE sap_category_id NOT IN (5,7,41,23,-999)) cat
ON 			cat.LEAF_CATEG_ID = lstg.LEAF_CATEG_ID
AND 		cat.SITE_ID = 3

WHERE 		1=1
AND 		tran.PAID_IND = 0
AND 		cal.RETAIL_YEAR = 2022
AND  		tran.SITE_ID = 3
AND 		tran.SLR_CNTRY_ID = 3
AND 		tran.ISCORE = 1
);


SELECT 
	RETAIL_YEAR
	,PAID_IND
	,META_CATEG_ID
	,META_CATEG_NAME
	,SUM(CAST(ITEM_PRICE_AMT * QUANTITY * LSTG_CURNCY_EXCHNG_RATE AS DECIMAL(18,2))) AS GMB
	
FROM 	TEMP_GMB_UPI_2022
WHERE 	META_CATEG_ID IN (64482)

GROUP BY 1,2,3,4;



SELECT 
	RETAIL_YEAR
	,PAID_IND
	,META_CATEG_ID
	,META_CATEG_NAME
	,CATEG_LVL2_ID
	,CATEG_LVL2_NAME
	,SUM(CAST(ITEM_PRICE_AMT * QUANTITY * LSTG_CURNCY_EXCHNG_RATE AS DECIMAL(18,2))) AS GMB
	
FROM 	TEMP_GMB_UPI_2022
WHERE 	CATEG_LVL2_ID IN (2536, 182982, 58520, 63)

GROUP BY 1,2,3,4,5,6;




SELECT 
	RETAIL_YEAR
	,PAID_IND
	,META_CATEG_ID
	,META_CATEG_NAME
	,CATEG_LVL2_ID
	,CATEG_LVL2_NAME
	,CATEG_LVL3_ID
	,CATEG_LVL3_NAME
	,SUM(CAST(ITEM_PRICE_AMT * QUANTITY * LSTG_CURNCY_EXCHNG_RATE AS DECIMAL(18,2))) AS GMB
	
FROM 	TEMP_GMB_UPI_2022
WHERE 	CATEG_LVL3_ID IN (183447, 149372)

GROUP BY 1,2,3,4,5,6,7,8;


