/*
Jira: https://jirap.corp.ebay.com/browse/UKPLAN-436

Objective: Provide data for WRAP on Sold Items to L4 for Fashion CSA

Description: 

Date: 05/07/2023

Author: Oliver Wand

*/
drop table if exists P_OLWAND_T.UKPLAN436_WRAP_DATA;
create table P_OLWAND_T.UKPLAN436_WRAP_DATA as 
select 
cal.RETAIL_YEAR
,case when cat.site_id = 3 then 'UK' else 'ROW' end as COUNTRY_FLAG
-- ,coalesce(cat_uk.META_CATEG_NAME,cat.META_CATEG_NAME) as META_CATEG_NAME
,coalesce(cat_uk.CATEG_LVL2_NAME,cat.CATEG_LVL2_NAME) as CATEG_LVL2_NAME
,coalesce(cat_uk.CATEG_LVL3_NAME,cat.CATEG_LVL3_NAME) as CATEG_LVL3_NAME
,coalesce(cat_uk.CATEG_LVL3_NAME,cat.CATEG_LVL3_NAME) as CATEG_LVL4_NAME
-- ,sum(tran.GMV20_PLAN) as GMV
,sum(tran.QUANTITY) as SI
from PRS_RESTRICTED_V.SLNG_TRANS_SUPER_FACT tran
inner join ACCESS_VIEWS.dw_cal_dt cal on tran.gmv_dt = cal.CAL_DT
inner join P_INVENTORYPLANNING_T.DW_CATEGORY_GROUPINGS_ADJ cat on tran.LEAF_CATEG_ID = cat.LEAF_CATEG_ID and tran.SITE_ID = cat.SITE_ID
left join P_INVENTORYPLANNING_T.DW_CATEGORY_GROUPINGS_ADJ cat_uk on tran.LEAF_CATEG_ID = cat_uk.LEAF_CATEG_ID and cat_uk.SITE_ID = 3
where 1=1
and tran.RPRTD_WACKO_YN = 'N'
and cal.AGE_FOR_RTL_YEAR_ID between -4 and -1
and cat.BSNS_VRTCL_NAME = 'Fashion'
and cat.META_CATEG_ID = 11450 -- CSA
and tran.CNDTN_ROLLUP_ID = 3 -- used
group by 1,2,3,4,5

;