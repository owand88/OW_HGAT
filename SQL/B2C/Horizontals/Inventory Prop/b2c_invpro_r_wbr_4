select retail_year, max(retail_week) from P_CSI_TBS_T.UKI_FINAL group by 1;

select * from P_UK_FPA_T.EU_FUNNEL
where retail_year = 2022 and retail_week = 13 and REV_ROLLUP = "UK"
limit 100;


/*select VERTICAL from P_UK_FPA_T.EU_FUNNEL1 group by 1;*/

DROP TABLE if exists P_UK_FPA_T.EU_FUNNEL1 ;
CREATE TABLE P_UK_FPA_T.EU_FUNNEL1 AS
	SELECT
		CAL.RETAIL_YEAR
		,CAL.RETAIL_WEEK
		,CAL.RETAIL_WK_END_DATE 
		,GEO.GLBL_RPRT_GEO_NAME AS REV_ROLLUP
		,VERT.GLBL_RPRT_BSNS_CTGRY_DESC AS VERTICAL
		,SUM(RUV_CNT) AS RUV
		,SUM(RUV_VISIT_CNT) AS VISITS
		,SUM(CORE_BUYER_CNT) AS BUYERS 
		,SUM(CORE_BI_CNT) AS BI
	FROM PRS_RESTRICTED_V.TRFC_DRILL_SRW  AS TRFC 
	INNER JOIN ACCESS_VIEWS.GLBL_RPRT_BSNS_CTGRY_LKP AS VERT 
		ON TRFC.GLBL_RPRT_BSNS_CTGRY_CD = VERT.GLBL_RPRT_BSNS_CTGRY_CD 
		AND VERT.GLBL_RPRT_BSNS_CTGRY_DESC NOT IN ('Real Estate', 'Unknown', 'Vehicles')
	INNER JOIN ACCESS_VIEWS.GLBL_RPRT_GEO_DIM AS GEO 
		ON TRFC.REV_ROLLUP_ID=GEO.REV_ROLLUP_ID 
		AND GLBL_RPRT_GEO_NAME IN ('DE', 'UK', 'FR', 'IT', 'ES')
	INNER JOIN DW_CAL_DT AS CAL 
		ON TRFC.RTL_WEEK_END_DT = CAL.CAL_DT  
		AND RETAIL_YEAR >= 2016
		AND AGE_FOR_RTL_WEEK_ID <= -1
	LEFT JOIN ACCESS_VIEWS.SSA_TRFC_DEVICE_EXPRNC_DIM AS DE 
		ON TRFC.GLBL_RPRT_DEVICE_EXPRNC_CD = DE.GLBL_RPRT_DEVICE_EXPRNC_CD
	WHERE 1=1
		AND TRFC.MNGD_TS_LVL1_CD=100
		AND TRFC.CUST_TS_LVL1_CD=100
		AND TRFC.CUST_TS_LVL2_CD = 100
		AND TRFC.TS_LVL4_CD=100 
		AND TRFC.DEVICE_LVL1_CD=100
		AND TRFC.DEVICE_LVL2_CD=100
		AND TRFC.EXPRNC_LVL1_CD=100
		AND TRFC.EXPRNC_LVL2_CD=100
	GROUP BY 1,2,3,4,5
;

--  === modified code 


DROP TABLE if exists P_CSI_TBS_T.CATEGORY_MAPPING  ;
CREATE  TABLE P_CSI_TBS_T.CATEGORY_MAPPING AS 
select   LEAF_CATEG_ID ,SITE_ID ,BSNS_VRTCL_NAME ,META_CATEG_ID ,  CATEG_LVL2_ID ,categ_lvl3_id
		from ACCESS_VIEWS.DW_CATEGORY_GROUPINGS    group by  1,2,3,4,5,6;



DROP TABLE if exists P_CSI_TBS_T.BASE_2018 ;
CREATE   TABLE P_CSI_TBS_T.BASE_2018 AS 

SELECT
			RETAIL_WK_END_DATE
			,CN.REV_ROLLUP
			,BSNS_VRTCL_NAME
			,META_CATEG_ID
			,CATEG_LVL2_ID
			,categ_lvl3_id
			,BUYER_ID
			,SELLER_ID
		FROM ACCESS_VIEWS.DW_CHECKOUT_TRANS AS CK
		INNER JOIN DW_COUNTRIES AS CN 
			ON CN.CNTRY_ID = CK.BYR_CNTRY_ID 
			AND CN.REV_ROLLUP  IN ('DE', 'UK', 'FR', 'IT', 'ES')
		INNER JOIN DW_COUNTRIES AS CN2 
			ON CN2.CNTRY_ID = CK.SLR_CNTRY_ID 
			AND CN2.REV_ROLLUP  IN ('DE', 'UK', 'FR', 'IT', 'ES') 
			AND CN.REV_ROLLUP = CN2.REV_ROLLUP
		INNER JOIN   P_CSI_TBS_T.CATEGORY_MAPPING AS CATEG 
			ON CATEG.LEAF_CATEG_ID = CK.LEAF_CATEG_ID 
			AND CATEG.SITE_ID = CK.SITE_ID 
			AND categ.BSNS_VRTCL_NAME NOT IN ('Real Estate', 'Unknown', 'Vehicles')
		INNER JOIN DW_CAL_DT AS CAL 
			ON CAL.CAL_DT = CK.GMV_DT
			AND RETAIL_YEAR = 2021 and retail_week between 1 and 26
			AND AGE_FOR_RTL_WEEK_ID <= -1
/*		INNER JOIN DW_USEGM_HIST AS HIST 
			ON HIST.USER_ID = CK.SELLER_ID 
			AND HIST.USEGM_GRP_ID = 48 
			AND CK.GMV_DTBETWEEN HIST.BEG_DATE AND HIST.END_DATE 
			AND HIST.USEGM_ID = 206 */
		WHERE 1=1
			AND GMV_DT>=  '2019-12-25'   and auct_end_dt >=   '2019-12-25'   
			AND CK.CK_WACKO_YN  =  'N'
			AND CK.SALE_TYPE NOT IN (10,15)
		GROUP BY 1,2,3,4,5,6,7,8 

;

insert into P_CSI_TBS_T.BASE_2018 
SELECT
			RETAIL_WK_END_DATE
			,CN.REV_ROLLUP
			,BSNS_VRTCL_NAME
			,META_CATEG_ID
			,CATEG_LVL2_ID
			,categ_lvl3_id
			,BUYER_ID
			,SELLER_ID
		FROM ACCESS_VIEWS.DW_CHECKOUT_TRANS AS CK
		INNER JOIN DW_COUNTRIES AS CN 
			ON CN.CNTRY_ID = CK.BYR_CNTRY_ID 
			AND CN.REV_ROLLUP  IN ('DE', 'UK', 'FR', 'IT', 'ES')
		INNER JOIN DW_COUNTRIES AS CN2 
			ON CN2.CNTRY_ID = CK.SLR_CNTRY_ID 
			AND CN2.REV_ROLLUP  IN ('DE', 'UK', 'FR', 'IT', 'ES') 
			AND CN.REV_ROLLUP = CN2.REV_ROLLUP
		INNER JOIN   P_CSI_TBS_T.CATEGORY_MAPPING AS CATEG 
			ON CATEG.LEAF_CATEG_ID = CK.LEAF_CATEG_ID 
			AND CATEG.SITE_ID = CK.SITE_ID 
			AND categ.BSNS_VRTCL_NAME NOT IN ('Real Estate', 'Unknown', 'Vehicles')
		INNER JOIN DW_CAL_DT AS CAL 
			ON CAL.CAL_DT = CK.GMV_DT
			AND RETAIL_YEAR = 2021 and retail_week between 27 and 52
			AND AGE_FOR_RTL_WEEK_ID <= -1
/*		INNER JOIN DW_USEGM_HIST AS HIST 
			ON HIST.USER_ID = CK.SELLER_ID 
			AND HIST.USEGM_GRP_ID = 48 
			AND CK.GMV_DTBETWEEN HIST.BEG_DATE AND HIST.END_DATE 
			AND HIST.USEGM_ID = 206 */
		WHERE 1=1
			AND GMV_DT>=  '2019-12-25'   and auct_end_dt >=   '2019-12-25'   
			AND CK.CK_WACKO_YN  =  'N'
			AND CK.SALE_TYPE NOT IN (10,15)
		GROUP BY 1,2,3,4,5,6,7,8 ;


insert into P_CSI_TBS_T.BASE_2018 
SELECT
			RETAIL_WK_END_DATE
			,CN.REV_ROLLUP
			,BSNS_VRTCL_NAME
			,META_CATEG_ID
			,CATEG_LVL2_ID
			,categ_lvl3_id
			,BUYER_ID
			,SELLER_ID
		FROM ACCESS_VIEWS.DW_CHECKOUT_TRANS AS CK
		INNER JOIN DW_COUNTRIES AS CN 
			ON CN.CNTRY_ID = CK.BYR_CNTRY_ID 
			AND CN.REV_ROLLUP  IN ('DE', 'UK', 'FR', 'IT', 'ES')
		INNER JOIN DW_COUNTRIES AS CN2 
			ON CN2.CNTRY_ID = CK.SLR_CNTRY_ID 
			AND CN2.REV_ROLLUP  IN ('DE', 'UK', 'FR', 'IT', 'ES') 
			AND CN.REV_ROLLUP = CN2.REV_ROLLUP
		INNER JOIN   P_CSI_TBS_T.CATEGORY_MAPPING AS CATEG 
			ON CATEG.LEAF_CATEG_ID = CK.LEAF_CATEG_ID 
			AND CATEG.SITE_ID = CK.SITE_ID 
			AND categ.BSNS_VRTCL_NAME NOT IN ('Real Estate', 'Unknown', 'Vehicles')
		INNER JOIN DW_CAL_DT AS CAL 
			ON CAL.CAL_DT = CK.GMV_DT
			AND RETAIL_YEAR = 2022 
			AND AGE_FOR_RTL_WEEK_ID <= -1
/*		INNER JOIN DW_USEGM_HIST AS HIST 
			ON HIST.USER_ID = CK.SELLER_ID 
			AND HIST.USEGM_GRP_ID = 48 
			AND CK.GMV_DTBETWEEN HIST.BEG_DATE AND HIST.END_DATE 
			AND HIST.USEGM_ID = 206 */
		WHERE 1=1
			AND GMV_DT>=  '2019-12-25'   and auct_end_dt >=   '2019-12-25'   
			AND CK.CK_WACKO_YN  =  'N'
			AND CK.SALE_TYPE NOT IN (10,15)
		GROUP BY 1,2,3,4,5,6,7,8 ;
--  select distinct BSNS_VRTCL_NAME from P_CSI_TBS_T.BASE_2018_1 ;

DROP TABLE if exists P_CSI_TBS_T.BASE_2018_1 ;
CREATE   TABLE P_CSI_TBS_T.BASE_2018_1 AS 


SELECT
			RETAIL_WK_END_DATE
			,REV_ROLLUP
			,BSNS_VRTCL_NAME
			,META_CATEG_ID
			,CATEG_LVL2_ID
			,categ_lvl3_id
			,BUYER_ID
	
		FROM    P_CSI_TBS_T.BASE_2018 CK
INNER JOIN DW_USEGM_HIST AS HIST 
			ON HIST.USER_ID = CK.SELLER_ID 
			AND HIST.USEGM_GRP_ID = 48 
			AND CK.RETAIL_WK_END_DATE BETWEEN HIST.BEG_DATE AND HIST.END_DATE 
			AND HIST.USEGM_ID = 206 
	/*	WHERE 1=1
			AND GMV_DT>=  '2016-01-03'   and GMV_DT<=  '2017-03-03'   
			AND CK.CK_WACKO_YN  =  'N'
			AND CK.SALE_TYPE NOT IN (10,15)*/
		GROUP BY 1,2,3,4,5,6,7;

-- DELETE  FROM  P_UK_FPA_T.EU_FUNNEL2 where RETAIL_WK_END_DATE ge date '2020-01-04' ; 

-- --   select min(RETAIL_WK_END_DATE),max(RETAIL_WK_END_DATE) from P_UK_FPA_T.EU_FUNNEL2 

-- select RETAIL_WK_END_DATE, count(*), sum(BUYERS_B2C_DOM) from P_UK_FPA_T.EU_FUNNEL2 group by 1;

--  select REV_ROLLUP,BSNS_VRTCL_NAME from P_UK_FPA_T.EU_FUNNEL2 group by 1,2;

---- update here ---- 

INSERT INTO P_UK_FPA_T.EU_FUNNEL2 
	SELECT 
		RETAIL_WK_END_DATE
		,CK.REV_ROLLUP
		,CASE 
			WHEN CK.REV_ROLLUP = 'DE' AND BSNS_VRTCL_NAME = 'Home & Garden' THEN
				CASE 
					WHEN META_CATEG_ID IN (3187, 20710, 22128) THEN BSNS_VRTCL_NAME || ' - Hard' 
					ELSE BSNS_VRTCL_NAME || ' - Soft' 
					END
			WHEN CK.REV_ROLLUP = 'UK' THEN
case when categ_lvl2_id in (20710, 69197, 185066) then 'Electronics' 
when meta_categ_id in (26395) then 'Lifestyle'
when CATEG_LVL3_ID in (260325) then 'Lifestyle'
when categ_lvl2_id in (386, 238, 1202, 49019, 183446, 80546, 222, 11731, 1082, 767, 233, 2613, 1188, 1039, 11743, 19169, 2562, 2616, 436, 14737, 2631, 2624, 717, 16486, 61573, 246) then 'Home & Garden'
when categ_lvl3_id in (35000, 98989) then 'Home & Garden'
when categ_lvl3_id in (3244) then 'Parts & Accessories'
when categ_lvl3_id in (124982, 259225,180969, 260509) then 'Business & Industrial'
when categ_lvl2_id in (46576) then 'Parts & Accessories'
when categ_lvl2_id in (63, 29223) then 'Collectibles'
else bsns_vrtcl_name end

			ELSE BSNS_VRTCL_NAME 
			END AS BSNS_VRTCL_NAME

---- update until ---- 
			
		,COUNT(DISTINCT RB.PRIMARY_USER_ID) AS BUYERS_B2C_DOM
	FROM 
		P_CSI_TBS_T.BASE_2018_1
	 AS CK
	INNER JOIN PRS_RESTRICTED_V.USER_DNA_DIM AS RB 
		ON RB.USER_ID = CK.BUYER_ID 
		-- where BSNS_VRTCL_NAME not in ('Collectibles')
	GROUP BY 1,2,3 ;

-- -- - select max(RETAIL_WK_END_DATE) from P_UK_FPA_T.EU_FUNNEL3 

--  select RETAIL_WK_END_DATE,GLBL_RPRT_GEO_NAME,BSNS_VRTCL_NAME,sum(GMV_B2C_DOM) GMV_B2C_DOM from P_UK_FPA_T.EU_FUNNEL3 group by 1,2,3;

--  select BSNS_VRTCL_NAME from P_UK_FPA_T.EU_FUNNEL3 group by 1

DROP TABLE if exists P_UK_FPA_T.EU_FUNNEL3 ;
CREATE  TABLE P_UK_FPA_T.EU_FUNNEL3 AS
SELECT 
		DT.RETAIL_WK_END_DATE
		,GEO.GLBL_RPRT_GEO_NAME 

---- update here ---- 
		,CASE 
			WHEN GEO.GLBL_RPRT_GEO_NAME = 'DE' AND BSNS_VRTCL_NAME = 'Home & Garden' THEN
				CASE 
					WHEN META_CATEG_ID IN (3187, 20710, 22128) THEN BSNS_VRTCL_NAME || ' - Hard' 
					ELSE  BSNS_VRTCL_NAME || ' - Soft' 
					END
			WHEN GEO.GLBL_RPRT_GEO_NAME = 'UK' THEN
case when categ_lvl2_id in (20710, 69197, 185066) then 'Electronics' 
when meta_categ_id in (26395) then 'Lifestyle'
when CATEG_LVL3_ID in (260325) then 'Lifestyle'
when categ_lvl2_id in (386, 238, 1202, 49019, 183446, 80546, 222, 11731, 1082, 767, 233, 2613, 1188, 1039, 11743, 19169, 2562, 2616, 436, 14737, 2631, 2624, 717, 16486, 61573, 246) then 'Home & Garden'
when categ_lvl3_id in (35000, 98989) then 'Home & Garden'
when categ_lvl3_id in (3244) then 'Parts & Accessories'
when categ_lvl3_id in (124982, 259225,180969, 260509) then 'Business & Industrial'
when categ_lvl2_id in (46576) then 'Parts & Accessories'
when categ_lvl2_id in (63, 29223) then 'Collectibles'
else bsns_vrtcl_name end				
			ELSE BSNS_VRTCL_NAME 
			END AS BSNS_VRTCL_NAME
---- update until ---- 

		,SUM(CASE WHEN CBT_REGION_CD <> 1 THEN X.GMB_PLAN_RATE_AMT ELSE 0 END) GMB_CBT
		,SUM(CASE WHEN CBT_REGION_CD = 1 AND USER_DSGNTN_ID = 2 THEN X.GMV_PLAN_RATE_AMT ELSE 0 END) GMV_B2C_DOM
		,SUM(CASE WHEN CBT_REGION_CD = 1 AND USER_DSGNTN_ID = 2 THEN X.GMB_PLAN_RATE_AMT ELSE 0 END) GMB_B2C_DOM
		,SUM(CASE WHEN CBT_REGION_CD = 1 AND USER_DSGNTN_ID = 2 THEN X.ITEM_SOLD_CNT ELSE 0 END) GMV_B2C_BI
		,SUM(CASE WHEN USER_DSGNTN_ID <>  2 THEN X.GMV_PLAN_RATE_AMT ELSE 0 END) GMV_C2C
		,SUM(CASE WHEN USER_DSGNTN_ID <>  2 THEN X.GMB_PLAN_RATE_AMT ELSE 0 END) GMB_C2C
		,SUM(CASE WHEN CBT_REGION_CD <> 1 AND USER_DSGNTN_ID = 2 THEN X.GMV_PLAN_RATE_AMT ELSE 0 END) GMV_B2C_CBT
		,SUM(CASE WHEN CBT_REGION_CD <> 1 AND USER_DSGNTN_ID = 2 THEN X.GMB_PLAN_RATE_AMT ELSE 0 END) GMB_B2C_CBT
		,SUM(X.GMV_PLAN_RATE_AMT) GMV
		,SUM(X.GMB_PLAN_RATE_AMT) GMB
	FROM PRS_RESTRICTED_V.SSA_FINANCE_HEALTH_DAILY_FACT AS X
	INNER JOIN ACCESS_VIEWS.DW_CAL_DT AS DT 
		ON X.CAL_DT = DT.CAL_DT 
		AND RETAIL_YEAR >= 2016
		AND AGE_FOR_RTL_WEEK_ID <= -1
	INNER JOIN ACCESS_VIEWS.GLBL_RPRT_GEO_DIM AS GEO 
		ON X.GLBL_RPRT_GEO_CD = GEO.GLBL_RPRT_GEO_CD
	INNER JOIN ACCESS_VIEWS.DW_CATEGORY_GROUPINGS AS CATEG 
		ON CATEG.LEAF_CATEG_ID = X.LEAF_CATEG_ID 
		AND CATEG.SITE_ID = X.LSTG_SITE_ID AND CATEG.BSNS_VRTCL_NAME NOT IN ('Real Estate', 'Unknown', 'Vehicles')
	WHERE GEO.GLBL_RPRT_GEO_NAME IN ('DE', 'UK', 'FR', 'IT', 'ES')
-- 	and BSNS_VRTCL_NAME not in ('Collectibles')
	GROUP BY 1,2,3
;
-- select RETAIL_YEAR, max(retail_week) from P_EUPRICING_T.B2C_BUYERS group by 1;
DROP TABLE IF EXISTS P_EUPRICING_T.B2C_BUYERS;
CREATE  TABLE P_EUPRICING_T.B2C_BUYERS  as 
SELECT 
			RETAIL_YEAR,
			RETAIL_Week,
			RETAIL_WK_END_DATE
			,CN.REV_ROLLUP
			,BSNS_VRTCL_NAME
			,META_CATEG_ID
			,CATEG_LVL2_ID
			,categ_lvl3_id
			,BUYER_ID
			,SELLER_ID
			,SUM(CK.QUANTITY) AS BI
		FROM DW_CHECKOUT_TRANS AS CK
		INNER JOIN DW_COUNTRIES AS CN 
			ON  CN.REV_ROLLUP  = 'DE'  and cn.cntry_id = ck.slr_cntry_id   and ck.slr_cntry_id = 77
		INNER JOIN ACCESS_VIEWS.DW_CATEGORY_GROUPINGS AS CATEG 
			ON CATEG.LEAF_CATEG_ID = CK.LEAF_CATEG_ID 
			AND CATEG.SITE_ID = CK.SITE_ID 
			AND CATEG.BSNS_VRTCL_NAME NOT IN ('Real Estate', 'Unknown', 'Vehicles')
		INNER JOIN DW_CAL_DT AS CAL 
			ON CAL.CAL_DT = CK.GMV_DT
			AND RETAIL_YEAR >= 2016
					AND AGE_FOR_RTL_WEEK_ID <= -1

		WHERE 1=1
			AND CK.GMV_DT>=  '2016-01-03'
			AND CK.CK_WACKO_YN  =  'N'
			AND CK.SALE_TYPE NOT IN (10,15)
		GROUP BY 1,2,3,4,5,6 ,7,8,9,10;

-- === Retail year and Retail Week level 

/*select retail_year,max(retail_week) from P_UK_FPA_T.EU_FUNNEL4  group by 1;*/

--  select distinct VERTICAL from P_UK_FPA_T.EU_FUNNEL4 

DROP TABLE if exists P_UK_FPA_T.EU_FUNNEL4 ;
CREATE  TABLE P_UK_FPA_T.EU_FUNNEL4 AS 
SELECT 
	RETAIL_YEAR,
	RETAIL_WEEK,
	RETAIL_WK_END_DATE,
	REV_ROLLUP,
	COALESCE(BSNS_VRTCL_NAME,'Total') AS VERTICAL
	,BUYERS_B2C
	,BI_B2C
FROM
	(SELECT 
		RETAIL_YEAR
		,RETAIL_WEEK,
		RETAIL_WK_END_DATE
		,CK.REV_ROLLUP
		,CASE 
			WHEN CK.REV_ROLLUP = 'DE' AND BSNS_VRTCL_NAME = 'Home & Garden' THEN
				CASE 
					WHEN META_CATEG_ID IN (3187, 20710, 22128) THEN BSNS_VRTCL_NAME || ' - Hard' 
					ELSE BSNS_VRTCL_NAME || ' - Soft' 
					END
				WHEN CK.REV_ROLLUP = 'UK' THEN
case when categ_lvl2_id in (20710, 69197, 185066) then 'Electronics' 
when meta_categ_id in (26395) then 'Lifestyle'
when CATEG_LVL3_ID in (260325) then 'Lifestyle'
when categ_lvl2_id in (386, 238, 1202, 49019, 183446, 80546, 222, 11731, 1082, 767, 233, 2613, 1188, 1039, 11743, 19169, 2562, 2616, 436, 14737, 2631, 2624, 717, 16486, 61573, 246) then 'Home & Garden'
when categ_lvl3_id in (35000, 98989) then 'Home & Garden'
when categ_lvl3_id in (3244) then 'Parts & Accessories'
when categ_lvl3_id in (124982, 259225,180969, 260509) then 'Business & Industrial'
when categ_lvl2_id in (46576) then 'Parts & Accessories'
when categ_lvl2_id in (63, 29223) then 'Collectibles'
else bsns_vrtcl_name end
			ELSE BSNS_VRTCL_NAME 
			END AS BSNS_VRTCL_NAME
		,COUNT(DISTINCT RB.PRIMARY_USER_ID) AS BUYERS_B2C
		,SUM(BI) AS BI_B2C

FROM P_EUPRICING_T.B2C_BUYERS CK

INNER JOIN DW_USEGM_HIST AS HIST 
			ON HIST.USER_ID = CK.SELLER_ID 
			AND HIST.USEGM_GRP_ID = 48 
			AND CK.RETAIL_WK_END_DATE BETWEEN HIST.BEG_DATE AND HIST.END_DATE 
			AND HIST.USEGM_ID = 206 

	INNER JOIN PRS_RESTRICTED_V.USER_DNA_DIM AS RB 
		ON RB.USER_ID = CK.BUYER_ID 

--  where BSNS_VRTCL_NAME not in ('Collectibles')		
	GROUP BY 1,2,3, 4,5) A;
	
-- 	select retail_year,max(retail_week) from P_UK_FPA_T.EU_FUNNEL5  group by 1;
	
-- 	select max(RETAIL_WK_END_DATE) from P_UK_FPA_T.EU_FUNNEL5  ;

--  select distinct BSNS_VRTCL_NAME from P_UK_FPA_T.EU_FUNNEL5 ;

drop table  P_UK_FPA_T.EU_FUNNEL5;
CREATE  TABLE P_UK_FPA_T.EU_FUNNEL5 AS
		
SELECT
DT.RETAIL_WK_END_DATE
,GEO.GLBL_RPRT_GEO_NAME ,
CASE 
WHEN GEO.FINANCE_GEO_GROUP_NAME = 'StubHub' THEN 'UNK'
WHEN GEO.FINANCE_GEO_GROUP_NAME = 'EMEA' 
THEN CASE 
	 WHEN CBT.CBT_REGION_DESC    IN ('EMEA Core','DOMESTIC') 
     THEN 
		 CASE WHEN USER_DSGNTN_ID = 2 THEN 'B2C' ELSE 'C2C' END
	 WHEN SLR_TYPE.SELLER_GROUP_CD = 101 THEN 'B2C' ELSE 'C2C' END
	 WHEN  GEO.FINANCE_GEO_GROUP_NAME IN ('APAC', 'AMER','APAC CBT') 
   		 THEN 
		 	CASE WHEN CBT.CBT_REGION_DESC  = 'EMEA Core' 
				THEN
					CASE WHEN USER_DSGNTN_ID = 2 THEN 'B2C' ELSE 'C2C' END
                 WHEN SLR_TYPE.SELLER_GROUP_CD = 101 THEN 'B2C' ELSE 'C2C' END ELSE 'UNK' 
END AS B2C_C2C_BUY  
,CASE 
WHEN GEO.GLBL_RPRT_GEO_NAME = 'DE' AND BSNS_VRTCL_NAME = 'Home & Garden' THEN
	CASE 
	WHEN META_CATEG_ID IN (3187, 20710, 22128) THEN BSNS_VRTCL_NAME || ' - Hard' 
	ELSE  BSNS_VRTCL_NAME || ' - Soft' 
	END
WHEN GEO.GLBL_RPRT_GEO_NAME = 'UK' THEN
case when categ_lvl2_id in (20710, 69197, 185066) then 'Electronics' 
when meta_categ_id in (26395) then 'Lifestyle'
when CATEG_LVL3_ID in (260325) then 'Lifestyle'
when categ_lvl2_id in (386, 238, 1202, 49019, 183446, 80546, 222, 11731, 1082, 767, 233, 2613, 1188, 1039, 11743, 19169, 2562, 2616, 436, 14737, 2631, 2624, 717, 16486, 61573, 246) then 'Home & Garden'
when categ_lvl3_id in (35000, 98989) then 'Home & Garden'
when categ_lvl3_id in (3244) then 'Parts & Accessories'
when categ_lvl3_id in (124982, 259225,180969, 260509) then 'Business & Industrial'
when categ_lvl2_id in (46576) then 'Parts & Accessories'
when categ_lvl2_id in (63, 29223) then 'Collectibles'
else bsns_vrtcl_name end			
ELSE BSNS_VRTCL_NAME 
END AS BSNS_VRTCL_NAME

,SUM(X.GMB_PLAN_RATE_AMT)  AS B2C_GMB
	FROM PRS_RESTRICTED_V.SSA_FINANCE_HEALTH_DAILY_FACT AS X
	INNER JOIN ACCESS_VIEWS.DW_CAL_DT AS DT 
		ON X.CAL_DT = DT.CAL_DT 
		AND RETAIL_YEAR >= 2016
		AND AGE_FOR_RTL_WEEK_ID <= -1
	INNER JOIN ACCESS_VIEWS.GLBL_RPRT_GEO_DIM AS GEO 
		ON X.GLBL_RPRT_GEO_CD = GEO.GLBL_RPRT_GEO_CD
	INNER JOIN ACCESS_VIEWS.DW_CATEGORY_GROUPINGS AS CATEG 
		ON CATEG.LEAF_CATEG_ID = X.LEAF_CATEG_ID 
		AND CATEG.SITE_ID = X.LSTG_SITE_ID AND CATEG.BSNS_VRTCL_NAME NOT IN ('Real Estate', 'Unknown', 'Vehicles')
		
			INNER 	JOIN  ACCESS_VIEWS.SSA_SELLER_TYPE_DIM AS SLR_TYPE    
ON    X.SELLER_TYPE_CD = SLR_TYPE.SELLER_TYPE_CD    

INNER JOIN ACCESS_VIEWS.SSA_CBT_REGION_DIM  CBT
ON    CBT.CBT_REGION_CD = X.CBT_REGION_CD  

	
		
	WHERE GEO.GLBL_RPRT_GEO_NAME IN ('DE', 'UK', 'FR', 'IT', 'ES') 
	AND (CASE 
  WHEN GEO.FINANCE_GEO_GROUP_NAME = 'StubHub' THEN 'UNK'
  WHEN GEO.FINANCE_GEO_GROUP_NAME = 'EMEA' 
   THEN CASE 
                 WHEN CBT.CBT_REGION_DESC    IN ('EMEA Core','DOMESTIC') 
                     THEN CASE 
                                  WHEN USER_DSGNTN_ID = 2 THEN 'B2C'
                                  ELSE 'C2C'  
                                END
                 WHEN SLR_TYPE.SELLER_GROUP_CD = 101 THEN 'B2C'
                 ELSE 'C2C'
                END
  WHEN  GEO.FINANCE_GEO_GROUP_NAME IN ('APAC', 'AMER','APAC CBT') 
   THEN CASE
                WHEN CBT.CBT_REGION_DESC  = 'EMEA Core'
                    THEN CASE 
                                 WHEN USER_DSGNTN_ID = 2 THEN 'B2C'
                                 ELSE 'C2C'
                                END
                 WHEN SLR_TYPE.SELLER_GROUP_CD = 101 THEN 'B2C'
                 ELSE 'C2C'
               END
ELSE 'UNK' 
END) IN ('B2C') --  and BSNS_VRTCL_NAME not in ('Collectibles')
	GROUP BY 1,2,3,4
;

--  select distinct VERTICAL from P_UK_FPA_T.EU_FUNNEL ;

--  select * from P_UK_FPA_T.EU_FUNNEL where retail_year=2021 and retail_week=15

-- select * from P_UK_FPA_T.EU_FUNNEL3 where glbl_rprt_geo_name in ('UK') and bsns_vrtcl_name in ('Collectibles')

drop table  P_UK_FPA_T.EU_FUNNEL ;
CREATE  TABLE P_UK_FPA_T.EU_FUNNEL AS
	SELECT
		cal.RETAIL_YEAR
		,cal.RETAIL_WEEK
		,cal.RETAIL_WK_END_DATE 
		,B.GLBL_RPRT_GEO_NAME as REV_ROLLUP
		,COALESCE(B.BSNS_VRTCL_NAME, 'Total') AS VERTICAL
		,A.RUV
		,A.VISITS
		,A.BUYERS 
		,A.BI
		,B.GMB_CBT
		,B.GMV_B2C_DOM
		,B.GMB_B2C_DOM
		,B.GMV_B2C_BI
		--,C.BUYERS_B2C_DOM
		,B.GMV_C2C
		,B.GMB_C2C
		,B.GMV_B2C_CBT
		,B.GMB_B2C_CBT
		,B.GMV
		,B.GMB
		,D.BUYERS_B2C
		,D.BI_B2C
				,e.b2c_gmb as GMB_B2C 
		
	FROM  P_UK_FPA_T.EU_FUNNEL3 AS B 
	join dw_Cal_dt as cal on b.RETAIL_WK_END_DATE=cal.RETAIL_WK_END_DATE 
left JOIN P_UK_FPA_T.EU_FUNNEL1 AS A 
		ON A.RETAIL_WK_END_DATE = B.RETAIL_WK_END_DATE 
		AND A.REV_ROLLUP = B.GLBL_RPRT_GEO_NAME 
		AND A.VERTICAL = CASE WHEN B.BSNS_VRTCL_NAME IS NULL THEN 'Total' WHEN B.BSNS_VRTCL_NAME LIKE '%Home & Garden%' THEN 'Home & Garden' ELSE B.BSNS_VRTCL_NAME END
				INNER JOIN P_UK_FPA_T.EU_FUNNEL5  AS E 
		ON b.RETAIL_WK_END_DATE = e.RETAIL_WK_END_DATE 
		AND b.GLBL_RPRT_GEO_NAME = e.GLBL_RPRT_GEO_NAME 
		AND coalesce( b.BSNS_VRTCL_NAME ,  'Total')  =   coalesce( E.BSNS_VRTCL_NAME ,  'Total') 
	--left JOIN P_UK_FPA_T.EU_FUNNEL2 AS C 
	--	ON A.RETAIL_WK_END_DATE = C.RETAIL_WK_END_DATE 
		-- AND A.REV_ROLLUP = C.REV_ROLLUP 
		-- AND COALESCE(B.BSNS_VRTCL_NAME, 'Total') = COALESCE(C.BSNS_VRTCL_NAME, 'Total')
	LEFT JOIN P_UK_FPA_T.EU_FUNNEL4 AS D 
		ON A.RETAIL_WK_END_DATE = D.RETAIL_WK_END_DATE 
		AND A.REV_ROLLUP = D.REV_ROLLUP 
/*		AND A.VERTICAL =
		CASE WHEN D.VERTICAL 
		 LIKE '%Home & Garden%' THEN 'Home & Garden' ELSE D.VERTICAL END*/
		 		AND COALESCE(B.BSNS_VRTCL_NAME, 'Total') = D.VERTICAL 
	
	-- where B.BSNS_VRTCL_NAME not in ('Collectibles')
	group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22
	
;

-- select retail_year, retail_week,VERTICAL,REV_ROLLUP,sum(GMV_B2C_DOM) GMV_B2C_DOM  from P_UK_FPA_T.EU_FUNNEL where retail_year=2021 group by 1,2,3,4;

--  select retail_year, retail_week,VERTICAL,REV_ROLLUP,sum(GMV_B2C_DOM) GMV_B2C_DOM  from P_UK_FPA_T.EU_FUNNEL6 where retail_year=2021 group by 1,2,3,4;

-- COLLECT STATISTICS ON P_UK_FPA_T.EU_FUNNEL INDEX (RETAIL_WK_END_DATE, REV_ROLLUP, VERTICAL);

--  select * from P_UK_FPA_T.EU_FUNNEL6 ;
DROP TABLE if exists P_UK_FPA_T.EU_FUNNEL6 ;
CREATE  TABLE P_UK_FPA_T.EU_FUNNEL6 AS
	SELECT
		RETAIL_YEAR
		,RETAIL_WEEK
		,RETAIL_WK_END_DATE 
		,REV_ROLLUP
		,'Total' AS VERTICAL
		,sum(RUV) RUV
		,sum(VISITS) VISITS
		,sum(BUYERS) BUYERS 
		,sum(BI) BI
		,sum(GMB_CBT) GMB_CBT
		,sum(GMV_B2C_DOM) GMV_B2C_DOM
		,sum(GMB_B2C_DOM) GMB_B2C_DOM
		,sum(GMV_B2C_BI) GMV_B2C_BI
		--,sum(BUYERS_B2C_DOM) BUYERS_B2C_DOM
		,sum(GMV_C2C) GMV_C2C
		,sum(GMB_C2C) GMB_C2C
		,sum(GMV_B2C_CBT) GMV_B2C_CBT
		,sum(GMB_B2C_CBT) GMB_B2C_CBT
		,sum(GMV) GMV
		,sum(GMB) GMB
		,sum(BUYERS_B2C) BUYERS_B2C
		,sum(BI_B2C) BI_B2C
		,sum(GMB_B2C) GMB_B2C 
		
	FROM  P_UK_FPA_T.EU_FUNNEL
	group by 1,2,3,4,5
;

create table P_UK_FPA_T.EU_FUNNEL_v1 as 
select * from P_UK_FPA_T.EU_FUNNEL
union all 
select * from P_UK_FPA_T.EU_FUNNEL6;

-- select * from P_UK_FPA_T.EU_FUNNEL where retail_year=2021 and retail_week=15 and rev_rollup in ('UK')

drop table P_UK_FPA_T.EU_FUNNEL;
create table P_UK_FPA_T.EU_FUNNEL as 
select * from P_UK_FPA_T.EU_FUNNEL_v1;
drop table P_UK_FPA_T.EU_FUNNEL_v1;


-- - select count(*) from P_UK_FPA_T.EU_FUNNEL3

--  select distinct VERTICAL from P_UK_FPA_T.EU_FUNNEL1
--  select distinct BSNS_VRTCL_NAME from P_UK_FPA_T.EU_FUNNEL3
--  select distinct BSNS_VRTCL_NAME from P_UK_FPA_T.EU_FUNNEL5
--  select distinct BSNS_VRTCL_NAME from P_UK_FPA_T.EU_FUNNEL2
--  select distinct VERTICAL from P_UK_FPA_T.EU_FUNNEL4

--  select BSNS_VRTCL_NAME from P_UK_FPA_T.EU_FUNNEL3  group by 1

/*DROP TABLE P_UK_FPA_T.EU_FUNNEL1;
DROP TABLE P_UK_FPA_T.EU_FUNNEL2;
DROP TABLE P_UK_FPA_T.EU_FUNNEL3;*/

SELECT MAX(RETAIL_WEEK) FROM P_UK_FPA_T.EU_FUNNEL WHERE RETAIL_YEAR = 2017;
SELECT MAX(RETAIL_YEAR) FROM P_UK_FPA_T.EU_FUNNEL;
SELECT MAX(RETAIL_WEEK) FROM P_UK_FPA_T.EU_FUNNEL WHERE RETAIL_YEAR = 2020;

SELECT retail_year, MAX(RETAIL_WEEK) FROM P_UK_FPA_T.EU_FUNNEL group by 1;

SELECT
	RW.RETAIL_YEAR
	,RW.RETAIL_WEEK
	,RW.REV_ROLLUP
	,RW.VERTICAL
	-- Current week current year
	,RW.GMV_B2C_DOM AS RW_GMV_B2C_DOM
	-- Last week current year
	,LW.GMV_B2C_DOM AS LW_GMV_B2C_DOM
	-- Current week last year
	,CWLY.GMV_B2C_DOM AS CWLY_GMV_B2C_DOM
	-- Current week last last year
	,CWL2Y.GMV_B2C_DOM AS CWL2Y_GMV_B2C_DOM
	-- Current quarter to date current year
	,QTR.GMV_B2C_DOM AS QTR_GMV_B2C_DOM
	-- Current quarter to date last year
	,QTR_LY.GMV_B2C_DOM AS QTR_LY_GMV_B2C_DOM
	-- Current year to date
	,CY.GMV_B2C_DOM AS CY_GMV_B2C_DOM
	-- Last year to date
	,LY.GMV_B2C_DOM AS LY_GMV_B2C_DOM
FROM
-- Current week - Current year actuals
	(SELECT
		F.RETAIL_YEAR
		,F.RETAIL_WEEK
		,F.RETAIL_WK_END_DATE	
		,REV_ROLLUP
		,VERTICAL
		,GMV_B2C_DOM
	FROM P_UK_FPA_T.EU_FUNNEL AS F
	INNER JOIN (SELECT RETAIL_YEAR, RETAIL_WEEK, RETAIL_WK_END_DATE FROM ACCESS_VIEWS.DW_CAL_DT WHERE AGE_FOR_RTL_WEEK_ID = -1 GROUP BY 1,2,3) AS CAL
		ON CAL.RETAIL_WK_END_DATE = F.RETAIL_WK_END_DATE
	) AS RW
INNER JOIN
-- Last week - Current year actuals
	(SELECT
		F.RETAIL_YEAR
		,F.RETAIL_WEEK
		,F.RETAIL_WK_END_DATE	
		,REV_ROLLUP
		,VERTICAL
		,GMV_B2C_DOM
	FROM P_UK_FPA_T.EU_FUNNEL AS F
	INNER JOIN (SELECT RETAIL_YEAR, RETAIL_WEEK, RETAIL_WK_END_DATE FROM ACCESS_VIEWS.DW_CAL_DT WHERE AGE_FOR_RTL_WEEK_ID = -2 GROUP BY 1,2,3) AS CAL
		ON CAL.RETAIL_WK_END_DATE = F.RETAIL_WK_END_DATE
		group by 1,2,3,4,5,6) AS LW
	ON RW.REV_ROLLUP = LW.REV_ROLLUP
	AND RW.VERTICAL = LW.VERTICAL
INNER JOIN	
-- Current week - Last year actuals
	(SELECT
		F.RETAIL_YEAR
		,F.RETAIL_WEEK
		,F.RETAIL_WK_END_DATE	
		,REV_ROLLUP
		,VERTICAL
		,GMV_B2C_DOM
	FROM P_UK_FPA_T.EU_FUNNEL AS F
	INNER JOIN (SELECT RETAIL_YEAR, RETAIL_WEEK, RETAIL_WK_END_DATE FROM ACCESS_VIEWS.DW_CAL_DT WHERE AGE_FOR_RTL_WEEK_ID = -1 -52 GROUP BY 1,2,3) AS CAL
		ON CAL.RETAIL_WK_END_DATE = F.RETAIL_WK_END_DATE
	) AS CWLY
	ON RW.REV_ROLLUP = CWLY.REV_ROLLUP
	AND RW.VERTICAL = CWLY.VERTICAL	
INNER JOIN	
-- Current week - Last last year actuals
	(SELECT
		F.RETAIL_YEAR
		,F.RETAIL_WEEK
		,F.RETAIL_WK_END_DATE	
		,REV_ROLLUP
		,VERTICAL
		,GMV_B2C_DOM
	FROM P_UK_FPA_T.EU_FUNNEL AS F
	INNER JOIN (SELECT RETAIL_YEAR, RETAIL_WEEK, RETAIL_WK_END_DATE FROM ACCESS_VIEWS.DW_CAL_DT WHERE AGE_FOR_RTL_WEEK_ID = -1 -52 -52 GROUP BY 1,2,3) AS CAL
		ON CAL.RETAIL_WK_END_DATE = F.RETAIL_WK_END_DATE
	) AS CWL2Y
	ON RW.REV_ROLLUP = CWL2Y.REV_ROLLUP
	AND RW.VERTICAL = CWL2Y.VERTICAL	
INNER JOIN	
-- Current quarter - Current year
	(SELECT
		REV_ROLLUP
		,VERTICAL
		,SUM(GMV_B2C_DOM) AS GMV_B2C_DOM
	FROM P_UK_FPA_T.EU_FUNNEL AS F
	INNER JOIN 
		(SELECT 
			RETAIL_YEAR
			,RETAIL_WEEK
			,RETAIL_WK_END_DATE 
		FROM ACCESS_VIEWS.DW_CAL_DT 
		WHERE 1=1
			AND AGE_FOR_RTL_QTR_ID =  (SELECT AGE_FOR_RTL_QTR_ID FROM ACCESS_VIEWS.DW_CAL_DT WHERE AGE_FOR_RTL_WEEK_ID = -1 GROUP BY 1)
			AND AGE_FOR_RTL_WEEK_ID <= -1
			GROUP BY 1,2,3
		) AS CAL
		ON CAL.RETAIL_WK_END_DATE = F.RETAIL_WK_END_DATE
	GROUP BY 1,2
	) AS QTR
	ON RW.REV_ROLLUP = QTR.REV_ROLLUP
	AND RW.VERTICAL = QTR.VERTICAL	
INNER JOIN		
-- Current quarter - Last year
	(SELECT
		REV_ROLLUP
		,VERTICAL
		,SUM(GMV_B2C_DOM) AS GMV_B2C_DOM
	FROM P_UK_FPA_T.EU_FUNNEL AS F
	INNER JOIN 
		(SELECT 
			RETAIL_YEAR
			,RETAIL_WEEK
			,RETAIL_WK_END_DATE
		FROM ACCESS_VIEWS.DW_CAL_DT 
		WHERE 1=1
			AND AGE_FOR_RTL_QTR_ID = (SELECT AGE_FOR_RTL_QTR_ID FROM ACCESS_VIEWS.DW_CAL_DT WHERE AGE_FOR_RTL_WEEK_ID = -1 GROUP BY 1) -4
			AND RETAIL_WEEK IN (SELECT RETAIL_WEEK FROM ACCESS_VIEWS.DW_CAL_DT WHERE AGE_FOR_RTL_QTR_ID = (SELECT AGE_FOR_RTL_QTR_ID FROM ACCESS_VIEWS.DW_CAL_DT WHERE AGE_FOR_RTL_WEEK_ID = -1 GROUP BY 1) AND AGE_FOR_RTL_WEEK_ID <= -1 GROUP BY 1)
		GROUP BY 1,2,3
		) AS CAL
		ON CAL.RETAIL_WK_END_DATE = F.RETAIL_WK_END_DATE
	GROUP BY 1,2
	) AS QTR_LY
	ON RW.REV_ROLLUP = QTR_LY.REV_ROLLUP
	AND RW.VERTICAL = QTR_LY.VERTICAL
INNER JOIN	
-- Current year
	(SELECT
		REV_ROLLUP
		,VERTICAL
		,SUM(GMV_B2C_DOM) AS GMV_B2C_DOM
	FROM P_UK_FPA_T.EU_FUNNEL AS F
	INNER JOIN 
		(SELECT 
			RETAIL_YEAR
			,RETAIL_WEEK
			,RETAIL_WK_END_DATE 
		FROM ACCESS_VIEWS.DW_CAL_DT 
		WHERE 1=1
			AND AGE_FOR_RTL_YEAR_ID = (SELECT AGE_FOR_RTL_YEAR_ID FROM ACCESS_VIEWS.DW_CAL_DT WHERE AGE_FOR_RTL_WEEK_ID = -1 GROUP BY 1) 
			AND AGE_FOR_RTL_WEEK_ID <= -1
		GROUP BY 1,2,3
		) AS CAL
		ON CAL.RETAIL_WK_END_DATE = F.RETAIL_WK_END_DATE
	GROUP BY 1,2
	) AS CY
		ON CY.REV_ROLLUP = RW.REV_ROLLUP
		AND CY.VERTICAL = RW.VERTICAL
INNER JOIN 
-- Last year
	(SELECT
		REV_ROLLUP
		,VERTICAL
		,SUM(GMV_B2C_DOM) AS GMV_B2C_DOM
	FROM P_UK_FPA_T.EU_FUNNEL AS F
	INNER JOIN 
		(SELECT 
			RETAIL_YEAR
			,RETAIL_WEEK
			,RETAIL_WK_END_DATE 
		FROM ACCESS_VIEWS.DW_CAL_DT 
		WHERE 1=1
			AND AGE_FOR_RTL_YEAR_ID = (SELECT AGE_FOR_RTL_YEAR_ID FROM ACCESS_VIEWS.DW_CAL_DT WHERE AGE_FOR_RTL_WEEK_ID = -1 GROUP BY 1) -1
			AND RETAIL_WEEK IN (SELECT RETAIL_WEEK FROM ACCESS_VIEWS.DW_CAL_DT WHERE AGE_FOR_RTL_YEAR_ID = (SELECT AGE_FOR_RTL_YEAR_ID FROM ACCESS_VIEWS.DW_CAL_DT WHERE AGE_FOR_RTL_WEEK_ID = -1 GROUP BY 1) AND AGE_FOR_RTL_WEEK_ID <= -1 GROUP BY 1)
		GROUP BY 1,2,3
		) AS CAL
		ON CAL.RETAIL_WK_END_DATE = F.RETAIL_WK_END_DATE
	GROUP BY 1,2
	) AS LY
	ON RW.REV_ROLLUP = LY.REV_ROLLUP
	AND RW.VERTICAL = LY.VERTICAL
WHERE RW.REV_ROLLUP = 'UK'
group by 1,2,3,4,5,6,7,8,9,10,11,12;

