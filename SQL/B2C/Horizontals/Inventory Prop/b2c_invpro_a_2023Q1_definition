/*
Task: 2023 Q1 inventory prop focus groups for Trading verticals
Objective: Quarterly update to include focus groups in regular report tracking	
*/

select
cal.retail_year
,cal.retail_week
,cal.rtl_qtr_of_rtl_year_id
,case when cat.categ_lvl2_id in (20710, 69197, 185066) then 'Electronics' 
      when cat.meta_categ_id in (26395) then 'Lifestyle'
      when cat.categ_lvl3_id in (260325) then 'Lifestyle'

      when cat.categ_lvl3_id in (35000, 98989) then 'Home & Garden'
      when cat.categ_lvl3_id in (3244) then 'Parts & Accessories'
      when cat.categ_lvl3_id in (124982, 259225,180969, 260509) then 'Business & Industrial'
      when cat.categ_lvl2_id in (46576) then 'Parts & Accessories'
      when cat.categ_lvl2_id in (63, 29223) then 'Collectibles'
      else cat.bsns_vrtcl_name end as new_vertical

,case
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Q1 Pro Trader Inv Prop 24/01/23
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- defined first due to overlap
when cat.categ_lvl3_id in (261994,261988,261993,261990,261989,261992,101437,261995,261991,261975,261977,261999,137843,14085,60115,137839,137856,10298,262003,262004,262005,262016,262006,262008,262011,262012,262013,166734,262014,262015,262007,262010,262009,262001,260325) 
and ck.seller_id in (1120406464,134304482,57840841,1038378555,325374982,1070085146,687544240,230389293,1178372338,1669034850,314987822,94324923,1149473447,1516330637,55636349,146732626,2427110257,1706309114,1592686816,2153237029,300222646,411947125,87217494,193399590,1231362947,1813879333,365735231,2298407919,1137164267
,1028037130,1906970499,1397020813,1086874666,1000243998,2217699786,1193156083,2264039823,2076849914,2221096629,365735231,1157577152,1241180667,46985308,1027943353,1310305527,291975149,484240490,144630961,1296060861,1317153690,2362571477,63019472,1174275765,814070408,1931765099,1162684051,2398747326,398982038,282204828,1014772649
,480992494,1133200523,1098596222,2394513851,309915899,59153567,234388974,1088471505,203214531,146754174,986591370,1661332377,16937493,1835540051,79668438,1380293356,2353351128,316193158,1592670226,1355250729,2381847736,61161564,758892726,1502881013,114802729,172110895,1386077481,38990840,263507813,1090533236,9716292,1893261252
,2229962775,2385399896,1317205733,1658422735,191262728,1153191840,2370235660,2378715024,1052081033,1206067863,2419760423,1608916559,1913277462,1088325962,2090615526,1831956905,2387536712,1307586654,199494040,1565333127,79007920,118378913,2295981780,109486490,1297566056,44672077,10020303,304071943,119915929,884786058,270720006
,1404586078,911717002,130221152,1207077776,1458291676,1192188169,1300826730,143318531,1840715311,1032307885,170339741,1459238071,2029599502,1005812166,180827173,1090533236,108561220,61313340,76665697,1124299881,76142059,925565467,7222799,1106715478,229018702,1243269814,1802284499,995199318,2003299193,2028348237,88512547,2069566520)
then 'Pro Trader Luxury Jewellery & Watches & Handbags'
when cndtn.cndtn_rollup_id in (3) and cat.meta_categ_id in (11450)
and ck.seller_id in (42942236,66003839,76829530,82480562,100120501,104043059,125195036,130747977,130767072,131563317,137956699,146445985,150353785,154016157,183059684,189495802,215881967,225684103,236365990,237503913,307192177,308013168,333955498,406522972,438132240,449110946,460349390,589584808,641945991,677157149,684628835
,693211033,706753239,727996431,749606652,876399046,889091297,899251621,905616125,956338743,956712338,985803664,1022818305,1023588063,1029021227,1030772073,1032596571,1033169535,1034311540,1036038123,1039576199,1041032362,1051858517,1064517454,1091616594,1094492781,1106029208,1107742470,1108524803,1134308905,1136134040,1136686710
,1138062592,1138703637,1140621130,1150021366,1151028677,1159905517,1166115664,1166818601,1167028784,1199345580,1216039659,1220266750,1228133540,1231951452,1240953517,1242678494,1251603698,1348539215,1365569718,1371546326,1378664255,1433534959,1445256641,1481012857,1487854181,1502778521,1503677405,1516114674,1552952019,1566788720
,1575383513,1583019209,1594935262,1603510342,1627164895,1657752120,1682970496,1734496887,1742484081,1753381952,1755118947,1764456739,1776714604,1790780924,1833757046,1853894023,1873084345,1875511145,1942371356,1956040403,1956225193,1962050377,2060042135,2067951122,2083002666,2085037916,2140414117,2172788920,2176601256,2179170040
,2198981554,2210493957,2230403971,2321191974,2331146070,2347959432,1597340320,56264907) then 'Pro Trader Preloved'
when cat.categ_lvl3_id in (96772,113814,96777,100969,20398,96773,45453,121471,53677,100982,15558,66674,20424,26268,20397,20399,45456,20408,162034,112376,20404,184344,23590,157325,32872,162032,32866,2986,20405,121627,66693,66695,100980,139760,32871,121629,100985,121631,87169,87170,121630,3081,20417,180907,134278,262978,162041,162040,20421,180909,100989,20432,53675,117035,100991,2985,20428,20429,20423,98473,2988,37633,20431,1261,37631,2989,180911,121634,66700,20435,184339,117026,162183,134762,184343,20436,117029,134761,179013,131082,131081,100225,131084,2990,134282,260019,163222,147285) then 'Pro Trader Baby'
when cat.categ_lvl3_id in (260590,176990,176991,260619,260556,260559,260560,260565,259851,260575,259835,3191,260630,259838,260588,259858,259867) then 'Pro Trader Bath'
when cat.categ_lvl3_id in (179448,179421) then 'Pro Trader Car Care & Paints'
when cndtn.item_cndtn_id in (1000) and cat.categ_lvl3_id in (33549,33612,33726,33637,33687,33605,33579,9886,33559,33694,33542) then 'Pro Trader Car Parts New'
when cndtn.cndtn_rollup_id in (3) and cat.categ_lvl3_id in (33549,33612,33726,33637,33687,33605,33579,9886,33559,33694,33542) then 'Pro Trader Car Parts Used'
when (cat.categ_lvl2_id in (16086) or cat.categ_lvl3_id in (102424,20935,170098,159928,98733,20938,20940,3268,102467,102473,20941,177762,102430,33156)) then 'Pro Trader Celebration & Occasion & Wedding'
when (cat.categ_lvl2_id in (58520) or cat.categ_lvl3_id in (246,149372,183447)) then 'Pro Trader Collectables'
when cndtn.item_cndtn_id in (1500,1750) and cat.categ_lvl3_id in (176985,176984,260307,43563,20667,71258,42231,45733,42231,38250) then 'Pro Trader Consumer Electronics'
when cat.categ_lvl3_id in (124982,180974,259225,260863,59032,41971,259243,41976,169182,180983,180972,83847,259231,259223,30524,260867,180974,20594,260853,124975,259236,260901,41969,260545,14953,260546,129768,115945,20589,98855,102536,112601,18626,41970,260551) then 'Pro Trader Diy Materials & Home Security'
when cat.categ_lvl3_id in (43990,183745,43986,43998,179469,179443,43985,179463,108798,61962,180152) then 'Pro Trader Garage Equipment And Tools'
when (cat.categ_lvl2_id in (25863,29518) or cat.categ_lvl3_id in (139956,180995,139939,180998,180992,177026,261010,180993,180997,180994,161059,159472,109072,261007,115773,261008,161045,261011)) then 'Pro Trader Garden Furniture, Structures & Tools'
when cat.categ_lvl2_id in (181003,181033,43554,179308) then 'Pro Trader Garden Tools, Plant Care & Hydroponics'
when cat.categ_lvl3_id in (260509,260449,260463,260496,115947) then 'Pro Trader Heating & Cooling'
when cat.categ_lvl2_id in (631) then 'Pro Trader Home DIY'
when (cat.categ_lvl2_id in (258031) or cat.categ_lvl3_id in (20585,103459,45515,260060,103458,175757,20706,112584,260153,20705,116675,20573,175820,91421,262982,36956,260156,20574,175517)) then 'Pro Trader Homewares'
when cat.categ_lvl3_id in (261986,43205,261988,262004,261990,50692,261993,261994,140010,261975,261977,261988,262004,261990,50692,261993,261994,262017,261988,261993,261994,173696,260328) then 'Pro Trader Jewellery & Watches (Non- Luxury)'
when (cat.categ_lvl2_id in (171146) or cat.categ_lvl3_id in (163147,312,3259)) then 'Pro Trader Kids & Speciality'
when cat.categ_lvl3_id in (180954,262436,1279,19258,180955,159881,260816,159880,11777,159886,183494,184585,159882) then 'Pro Trader Sports & Health'
when cat.categ_lvl2_id in (43502) then 'Pro Trader Storage'
when cat.categ_lvl2_id in (20498,42154,149242,20727) then 'Pro Trader Swimming & Outdoor Heating/ Cooking/Dining'
when cndtn.item_cndtn_id in (1000) and cat.categ_lvl3_id in (178893,9355,177,111422,179,111418,11195,1245,182086,11205,20311,44932,182097,158840,74941,3668,67858,51169,31492,116848,182096,58300,31493,171485,182089,27386,164,1244,170083,42017,42000,131511,175674,182088,16145,3761,182090,44980,168059,80053,51052,25321,175688,99231,158845,168068,260137,31510,14295,3709,4616,23895,31519,80183,175678,51082,31534,3702,175677,116346,116309,96915,75518,67870,31529,175679,42190,158846,170597,158837,175680,23160,33963,47779,3680,170,51086) then 'Pro Trader Technology - New'
when cndtn.item_cndtn_id in (1500,1750) and cat.categ_lvl3_id in (178893,9355,177,111422,179,111418,11195,1245,182086,11205,20311,44932,182097,158840,74941,3668,67858,51169,31492,116848,182096,58300,31493,171485,182089,27386,164,1244,170083,42017,42000,131511,175674,182088,16145,3761,182090,44980,168059,80053,51052,25321,175688,99231,158845,168068,260137,31510,14295,3709,4616,23895,31519,80183,175678,51082,31534,3702,175677,116346,116309,96915,75518,67870,31529,175679,42190,158846,170597,158837,175680,23160,33963,47779,3680,170,51086) then 'Pro Trader Technology - Refurb/ New Other / Used'

else 'OTHERS' end as inventory_prop

,case when inventory_prop like ('%Focus%') then 'Focused'
when inventory_prop like ('%Scal%') then 'Scaling'
when inventory_prop like ('%Protrader%') then 'Protrader'
when inventory_prop like ('%Other%') then 'ROnew_vertical'
else 'NA'
end as focus_flag

,sum(ck.GMV_PLAN_USD) as GMV
,sum(ck.quantity) AS BI

from access_views.dw_checkout_trans ck 

inner join access_views.dw_lstg_item lstg
on ck.item_id=lstg.item_id
        
inner join (select meta_categ_id,categ_lvl2_id,categ_lvl3_id,categ_lvl4_id,leaf_categ_id,site_id,bsns_vrtcl_name 
	        from access_views.dw_category_groupings 
			where sap_category_id not in (5,7,41,23,-999) 
			group by 1,2,3,4,5,6,7)  as cat
on lstg.leaf_categ_id=cat.leaf_categ_id
and lstg.item_site_id=cat.site_id and cat.site_id=3
        
inner join access_views.dw_cal_dt as cal
on cal.cal_dt=ck.GMV_dt
--and cal.age_for_rtl_year_id=0 and cal.age_for_rtl_week_id<=-1
and cal.age_for_rtl_week_id=-1

inner join (select usegm_grp_id,usegm_id,end_date,user_id,beg_date 
		    from access_views.dw_usegm_hist 
	        where usegm_grp_id = 48 																						
	        and usegm_id = 206 																								
	        and end_date >= '2015-12-30' 
			group by 1,2,3,4,5) as hist 																						
on hist.user_id=lstg.slr_id and lstg.auct_start_dt between hist.beg_date and hist.end_date	
        
left join (select item_id,cndtn_rollup_id,item_cndtn_id from access_views.lstg_item_cndtn group by 1,2,3) cndtn
on lstg.item_id=cndtn.item_id

and ck.slr_cntry_id=3 
and ck.byr_cntry_id=3 
and ck.slr_cntry_id=ck.byr_cntry_id 
and ck.rprtd_wacko_yn='N'
and ck.auct_end_dt>'2018-12-29'
and lstg.auct_type_code not in (10,15)
and lstg.item_site_id = 3

group by 1,2,3,4,5,6
;
