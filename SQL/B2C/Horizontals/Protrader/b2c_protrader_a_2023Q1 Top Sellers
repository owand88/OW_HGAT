	DROP TABLE if exists P_smb_sd_t.pro_trader_qtr_base;
CREATE temporary TABLE P_smb_sd_t.pro_trader_qtr_base AS
(


SELECT
ck.seller_id,
user_slctd_id,
case when categ_lvl2_id in (20710, 69197, 185066) then 'Electronics' 
when meta_categ_id in (26395) then 'Lifestyle'
when CATEG_LVL3_ID in (260325) then 'Lifestyle'
when categ_lvl2_id in (386, 238, 1202, 49019, 183446, 80546, 222, 11731, 1082, 767, 233, 2613, 1188, 1039, 11743, 19169, 2562, 2616, 436, 14737, 2631, 2624, 717, 16486, 61573, 246) then 'Home & Garden'
when categ_lvl3_id in (35000, 98989) then 'Home & Garden'
when categ_lvl3_id in (3244) then 'Parts & Accessories'
when categ_lvl3_id in (124982, 259225,180969, 260509) then 'Business & Industrial'
when categ_lvl2_id in (46576) then 'Parts & Accessories'
when categ_lvl2_id in (63, 29223) then 'Collectibles'
else bsns_vrtcl_name end as new_vertical, 
B.seller_id as focused_seller_id,

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 2023Q1 Pro Trader Inv Prop 6/12/2022 
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- defined first due to overlap
-- when categ_lvl3_id in (4250,1059,93427,4251,169291,15724,3034) and ck.seller_id in (1575383513,1220266750,72501954)  then 'Protrader Pre-Loved'
-- when categ_lvl3_id in (93427,3034) and ck.seller_id in (1180847104,1129053078,2379410309,1415417245,1024114570)  then 'Protrader Luxury Sneakers'
-- when categ_lvl3_id in (4250,93427,260325,169291,3034) and ck.seller_id in (180827173,132952595)  then 'Protrader Luxury Watches & Handbags'

case
when categ_lvl3_id in (124982,180974,259225,260863,59032,41971,259243,41976,169182,180983,180972,83847,259231,259223,30524,260867,180974,20594,260853,124975,259236,260901,41969,260545,14953,260546,129768,115945,20589,98855,102536,112601,18626,41970,260551) then 'Pro Trader DIY Materials & Home Security'
when categ_lvl2_id in (3197) and categ_lvl3_id in (179690,22653,131579,183320,260157,34386,166365,32254,38208,38204,54235,20487,103430,3199,107578,114397,20488,88057,183322,20480,103431,38199,20490,32878,48319,175754,125085,115753) then 'Pro-Trader Furniture'
when categ_lvl3_id in (139849,79682,79683,177031,112590,10035,20719,79684,260928,79700,184533,138996,139956,180995,139939,180998,180992,177026,261010,180993,180997,180994,161059,159472,109072,261007,115773,261008,161045,261011,50388,71277,71268,85915,42226,71278,71273,42228,29519,39019,261019,261016,169164,261012,71266,159930,161001,79670,261015,261014,261020,42230,261017,84204,126403) then 'Pro Trader Garden Furniture, Structures & Tools'
when categ_lvl2_id in (10033) and categ_lvl3_id in (79654,31587,159889,20580,4959,20549,262984,38237,36025,10034,101415,125072,31601,41511) then 'Pro Trader Home Decor'
when categ_lvl3_id in (3247,3244,260176,130140,42622,11704,29523,43614,85759,260220,260231,260232,171208) then 'Pro Trader Home DIY'
when categ_lvl3_id in (261994,261988,261993,261990,261989,261992,101437,261995,261991,261975,261977,137856,137839,261999,137843,10298,14085,60115,262013,262014,262004,262003,262008,166734,262016,262012,262011,262006,262015,262005,262007,262010,262009,262001,260325,169291) then 'Pro Trader Luxury'
when categ_lvl3_id in (179985,179973,179961,261028,261030,179978,179965,384,261031,180001,29723,178885,261029,62143) then 'Pro Trader Sports'
when categ_lvl3_id in (180954,262436,1279,19258,180955,159881,260816,159880,11777,159886,183494,184585,159882,260758,260764,260772,260762,47940,36430,112563,107965,28066,28059,28064,44075,158913,158916,158927,13362,68816) then 'Pro Trader Sports & Health & Beauty'
when categ_lvl2_id in (360,28009) then 'Pro Trader Art'
when categ_lvl3_id in (96772,113814,96777,100969,20398,96773,45453,121471,53677,100982,15558,66674,20424,26268,20397,20399,45456,20408,162034,112376,20404,184344,23590,157325,32872,162032,32866,2986,20405,121627,66693,66695,100980,139760,32871,121629,100985,121631,87169,87170,121630,3081,20417,180907,134278,262978,162041,162040,20421,180909,100989,20432,53675,117035,100991,2985,20428,20429,20423,98473,2988,37633,20431,1261,37631,2989,180911,121634,66700,20435,184339,117026,162183,134762,184343,20436,117029,134761,179013,131082,131081,100225,131084,2990,134282,260019,163222,147285) then 'Pro-Trader Baby'
when categ_lvl3_id in (260590,176990,176991,260619,260556,260559,260560,260565,259851,260575,259835,3191,260630,259838,260588,259858,259867) then 'Pro-Trader Bath'
when categ_lvl3_id in (179448,179421) then 'Protrader Car care & Paints'
when categ_lvl3_id in (33549,33612,33726,33637,33687,33605,33579,9886,33559,33694,33542) and cndtn_rollup_id in (1) then 'Protrader Car Parts New'
when categ_lvl3_id in (33549,33612,33726,33637,33687,33605,33579,9886,33559,33694,33542) and cndtn_rollup_id in (3) then 'Protrader Car Parts Used'
when categ_lvl3_id in (3205,170115,170098,170090,102378,16091,178069,102424,20935,170098,159928,98733,20938,20940,3268,102467,102473,20941,177762,102430,33156) then 'Pro-Trader Celebration & Occasion & Wedding'
when categ_lvl3_id in (246,149372,183447,3394,549,256,4733,45148,253,3410,58533,122493,548) then 'Pro-Trader Collectables'
when categ_lvl3_id in (176985,176984,260307,43563,20667,71258,42231,45733,42231,38250,32852,175711,22610,72406,48655,11725,71583,163829,71584,61312,168058,48656,32834,14964,64619,163768,61395,61336,258042,175721,184637,184647,175719,71585,31197,258046,122649,149958,64588,163826,149975,184638,14990,14970,48647,81741,4787,14971,14981,175708,48645,22635,4786,3271,11071,112529,111694,96954,73839,56169,48626,15053,163769,15054,15056,184618,260318,109256) then 'Pro-Trader Consumer Electronics'
when categ_lvl3_id in (943,183120,134560) then 'Pro-Trader Fabric'
when categ_lvl3_id in (43990,183745,43986,43998,179469,179443,43985,179463,108798,61962,180152) then 'Protrader Garage Equipment and Tools'
when categ_lvl3_id in (19617,151620,75664,181010,122906,260844,178978,181011,118867,118868,260927,115775,161015,139868,178980,178982,3186,178981,118864,149313,139870,139871,118869,139872,178983,147827,178977,75671,260940,260953,260942,260947,178993,178990,260949,178992,20546,178986,260941,40605,181052,181006,181004,40605,181052,181006,181004,181005,20518,119683,159406,181001,178984,25876,159419,159452,181002,181000,139001,75670,134671,159455,260944) then 'Pro-Trader Garden Tools, Plant care & Hydroponics'
when categ_lvl3_id in (260509,260449,260463,260496,115947) then 'Pro-Trader Heating & Cooling'
when categ_lvl3_id in (79643,101408,79644,175753,20559,20562,20561,20585,103459,45515,260060,103458,175757,20706,112584,260153,20705,116675,20573,175820,91421,262982,36956,260156,20574,175517) then 'Pro-Trader Homewares'
when categ_lvl3_id in (261986,43205,261988,262004,261990,50692,261993,261994,140010,261975,261977,261988,262004,261990,50692,261993,261994,262017,261988,261993,261994,173696,260328) then 'Pro-Trader Jewellery & Watches (non- luxury)'
when categ_lvl2_id in (171146) or categ_lvl3_id in (163147,312,3259) then 'Pro-Trader Kids & Speciality'
when META_CATEG_ID in (176985,176984) or categ_lvl3_id in (261186,617) then 'Pro-Trader Media'
when categ_lvl2_id in (260012,260010) then 'Pro-Trader Mens & Womens Fashion'
when categ_lvl3_id in (163896,41459,69965,182110,14985,157158,91384,182111,48460,19699,262426,29946,163862,69967,175833,64604,64606,64602,4785,69960,177023,177024,132998,29945,170089,81970,30889,177022,12921,38071,41404,101555,1288,64388,41396,159943,16215,181254,101554,16216,16214,179015,33021,4713,181221,119544,33034,22966,38072,47067,181220,180009,181219,182150,308,41441,181227,181228,181246,181249,622,181254,38088,181282,16219,1289,180009,181225,168129,163896,123445,41459,69965,261865,29946,178896,3278,119018,113484,15199,38070,23791,177027,47092,47091,175833,177028,38071,119019,181282,181281,623,181254,181267,181282,624,181254) then 'Pro-Trader Musical Instruments & DJ Equipment'
when categ_lvl3_id in (184161,184227,61673,184149,184165,1304,26220,260910,25301,11828,92079,25319,19273,50204,25307,109551,26224,57004,124982,180974,259225,260863,59032,41971,259243,41976,169182,180983,180972,83847,259231,259223,30524,260867,180974,20594,260853,124975,259236,260901,41969,260545,14953,260546,129768,115945,20589,98855,102536,112601,18626,41970,260551) then 'Protrader Office Supplies & Material Handling'
when META_CATEG_ID in (11450) then 'Pro-Trader Preloved'
when categ_lvl3_id in (36589,28141,3094,183209,28147,183233,183231,183205,183253,3118,183270,3115,180929,28174,28172,180930,183265,183281,147840,83965,183274,183286) then 'Pro-Trader Sewing & Needlework'
when categ_lvl3_id in (166325,22656,122772,38223,20621,43506,43504,159898,159897,122954,40620,36024,43503) then 'Pro-Trader Storage'
when categ_lvl3_id in (178893,9355,177,111422,179,111418,11195,1245,182086,11205,20311,44932,182097,158840,74941,3668,67858,51169,31492,116848,182096,58300,31493,171485,182089,27386,164,1244,170083,42017,42000,131511,175674,182088,16145,3761,182090,44980,168059,80053,51052,25321,175688,99231,158845,168068,260137,31510,14295,3709,4616,23895,31519,80183,175678,51082,31534,3702,175677,116346,116309,96915,75518,67870,31529,175679,42190,158846,170597,158837,175680,23160,33963,47779,3680,170,51086) and item_cndtn_id in (1000) then 'Pro-Trader Technology - NEW'
when categ_lvl3_id in (178893,9355,177,111422,179,111418,11195,1245,182086,11205,20311,44932,182097,158840,74941,3668,67858,51169,31492,116848,182096,58300,31493,171485,182089,27386,164,1244,170083,42017,42000,131511,175674,182088,16145,3761,182090,44980,168059,80053,51052,25321,175688,99231,158845,168068,260137,31510,14295,3709,4616,23895,31519,80183,175678,51082,31534,3702,175677,116346,116309,96915,75518,67870,31529,175679,42190,158846,170597,158837,175680,23160,33963,47779,3680,170,51086) and cndtn_rollup_id in (1,2,3)  then 'Pro-Trader Technology - Refurb/ New Other / Used'
else 'OTHERS' 
end as inventory_prop,

SUM(CASE WHEN age_for_rtl_week_id between -12 and -1 then GMV_PLAN_USD else 0 end) AS L4_Month_GMV,
SUM(CASE WHEN age_for_rtl_week_id between -12 and -1 then CK.QUANTITY else 0 end) AS L4_Month_BI,
SUM(CASE WHEN age_for_rtl_week_id between -52 and -1 then GMV_PLAN_USD else 0 end) AS L12_Month_GMV,
SUM(CASE WHEN age_for_rtl_week_id between -52 and -1 then CK.QUANTITY else 0 end) AS L12_Month_BI

   FROM  DW_CHECKOUT_TRANS ck 
    INNER JOIN ( select CURNCY_PLAN_RATE,CURNCY_ID from  ACCESS_VIEWS.SSA_CURNCY_PLAN_RATE_DIM group by 1,2)AS SSA 
        ON SSA.CURNCY_ID = CK.LSTG_CURNCY_ID     
        
    INNER JOIN ( select meta_categ_id, CATEG_LVL2_ID, categ_lvl2_name, categ_lvl3_name, categ_lvl3_id, categ_lvl4_id, LEAF_CATEG_ID,SITE_ID,BSNS_VRTCL_NAME   from ACCESS_VIEWS.DW_CATEGORY_GROUPINGS where SAP_CATEGORY_ID NOT IN (5,7,41,23,-999) group by 1,2,3,4,5,6,7,8, 9 )  AS CAT
        ON CK.LEAF_CATEG_ID = CAT.LEAF_CATEG_ID
        AND CAT.SITE_ID = 3
        
	inner join  DW_USERS u on ck.seller_id = u.user_id
    INNER JOIN ACCESS_VIEWS.DW_CAL_DT AS CAL
        ON CAL.CAL_DT = CK.GMV_DT
        AND age_for_rtl_week_id between -52 and -1 

LEFT JOIN (select USER_ID, SPS_SLR_LEVEL_CD 
FROM (select USER_ID,
	SPS_SLR_LEVEL_CD,
	last_eval_Dt from  PRS_RESTRICTED_V.SPS_LEVEL_METRIC_SUM X
	where SPS_EVAL_TYPE_CD = 1 AND SPS_PRGRM_ID = 3 
		group by 1,2,3 
		qualify (row_number() over (partition by user_id order by last_eval_Dt desc))=1) 
	where SPS_SLR_LEVEL_CD not in (4) 
	group by 1,2) SPS	ON sps.user_id = ck.SELLER_ID
	
left outer join (select seller_id from P_awang_ops_t.seller_ops_83 group by 1) b
on ck.seller_id = b.seller_id

    INNER JOIN ( select USEGM_GRP_ID,USEGM_ID,END_DATE,USER_ID,BEG_DATE from DW_USEGM_HIST where 
        USEGM_GRP_ID = 48 
        AND USEGM_ID = 206 
        AND END_DATE >= '2015-12-30' group by 1,2,3,4,5)AS HIST 
        ON HIST.USER_ID = CK.SELLER_ID
        AND CK.CREATED_DT BETWEEN HIST.BEG_DATE AND HIST.END_DATE
        
    left JOIN ( select ITEM_ID,item_cndtn_id,CNDTN_ROLLUP_ID from ACCESS_VIEWS.LSTG_ITEM_CNDTN group by 1,2,3 ) AS CNDTN ON CK.ITEM_ID = CNDTN.ITEM_ID
 
    WHERE 1=1	
and  ck.site_id = 3 
        AND BYR_CNTRY_ID = 3 
        AND RPRTD_WACKO_YN = 'N'
        AND AUCT_END_DT >= '2020-12-20'
        AND CREATED_DT >= '2020-12-20'     

    GROUP BY 1,2,3,4,5
	--having new_vertical = 'Fashion'
	qualify (row_number() over (partition by inventory_prop order by L12_Month_GMV desc))<= 750
	
	
	);


DROP TABLE if exists P_smb_sd_t.pro_trader_qtr_LL;
CREATE temporary TABLE P_smb_sd_t.pro_trader_qtr_ll AS
	
(SELECT
ck.slr_id,
count(ITEM_ID) as LL
FROM PRS_RESTRICTED_V.SLNG_LSTG_SUPER_FACT_EXT CK

inner join  (select seller_id from P_smb_sd_t.pro_trader_qtr_base group by 1) b3
on ck.slr_id = b3.seller_id 

WHERE ck.AUCT_END_DT > CURRENT_DATE
AND CK.AUCT_TYPE_CODE NOT IN (10,15)
AND CK.ITEM_SITE_ID = 3
		group by 1);
		
		
		select a.*,
		LL
		from P_smb_sd_t.pro_trader_qtr_base a
		
		inner join P_smb_sd_t.pro_trader_qtr_LL b
		on a.seller_id = b.slr_id 
		where inventory_prop IN ('Pro-Trader Baby')
	
		--where inventory_prop NOT IN ('Other')
	
	
select distinct inventory_prop from P_smb_sd_t.pro_trader_qtr_base
	where inventory_prop = 'Pro-Trader Media'