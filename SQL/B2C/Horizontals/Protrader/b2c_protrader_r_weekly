
drop table if exists P_awang_ops_t.Protrader_inventory_prop1;
CREATE TABLE  P_awang_ops_t.Protrader_inventory_prop1 AS
(SELect
RETAIL_YEAR,
retail_week,
BSNS_VRTCL_NAME,
case when categ_lvl2_id in (20710, 69197, 185066) then 'Electronics' 
when meta_categ_id in (26395) then 'Lifestyle'
when CATEG_LVL3_ID in (260325) then 'Lifestyle'
when categ_lvl2_id in (386, 238, 1202, 49019, 183446, 80546, 222, 11731, 1082, 767, 233, 2613, 1188, 1039, 11743, 19169, 2562, 2616, 436, 14737, 2631, 2624, 717, 16486, 61573, 246) then 'Home & Garden'
when categ_lvl3_id in (35000, 98989) then 'Home & Garden'
when categ_lvl3_id in (3244) then 'Parts & Accessories'
when categ_lvl3_id in (124982, 259225,180969, 260509) then 'Business & Industrial'
when categ_lvl2_id in (46576) then 'Parts & Accessories'
when categ_lvl2_id in (63, 29223) then 'Collectibles'
else bsns_vrtcl_name end as new_vertical, 
--B.seller_id as focused_seller_id,


case
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Q4 Pro Trader Inv Prop 6/10/22
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- defined first due to overlap
 when cat.meta_categ_id in (11450) and ck.seller_id in (307192177,1481012857,1757932344,1575383513,2210493957,773995006,1023588063,1199345580,82480562,237808021,706753239,1145963029,2267515823,1983590617,1552952019,2015587990,
 844787885,757526432,87068066,130747977,684628835,66003839,162019022,1956225193,100120501,1502778521,1376647487,1138703637,779492056,189495802,130767072,137956699,1043622463,1734496887,1503677405,876399046,2139893858,2192741079,1348539215,
 1207090376,1069427042,1857209412,1472932493,2008064034,241885773,47767499,127958869,1437288465,895658187,1596600617,925364946,2190598554,2321191974,2140414117,568770265,2045937738,1064517454,727996431,56441205,72501954,303794277,1149724322
 ,2188685622,1204012898,708929217,1583019209,1453078921,100975179,1376647487,1018004872,1615320668,932543695,1956225193,1020106378,1155838452,112626381,986620253,1792187227,838615039,2347959432,32373220,1010737404,406522972,795067569,731894315
 ,1444763902,1189377898,1121792323,1072903166,1682970496,641945991,1106802271,105877760,1566788720,200219208,67202535,1175821415,101106197,2306346724,182008565,181814486,136081930,1755118947,1086795106,1150021366,1166115664,693211033,1156547993
 ,731522388,1942371356,1045472445,162848198,238071968,1711911003,43174093,1166899945,67186775,1276697773,1481012857,2357566726,2388675071,168710399,1123656737,385712396,1415854000,155155735,74749887,24285743,1118217715,2090743468,1487854181,2401534552
 ,589584808,2067951122,1094492781,2416797447,1022818305,1593421075,1593208052,2364515191,1808450679,370085063,1594935262,1127480607,1278754749,64457901,460349390,1838268376,2281149511,1070682084,1629110227,449110946,1853894023,894890636,693211033,106008194
 ,1959627728,945168871,1983590617,236365990,1160961108,749606652,2364515191,71923414,1069090918,1125163357,1487198031,1402205790,1562312075,1157133803,1263331260,1018868549,1179776256,787759223,775905101,2042716022)  then 'Pro Trader Pre-Loved'
 when (cat.categ_lvl3_id in (95672, 15709, 155202, 57974, 57929,169291) or categ_lvl4_id in (52357)) and ck.seller_id in (1835540051,1216039659,803563110,1054523089,2416797447,1813879333,1150021366,127004873,1599568314,1599083503,118945299,1380293356,1601299011,814070408,486619000,509007270,1123656737,1138703637,1062541899,305587902,2086661886,359013244,1132432833,1415854000,1193523886,1485357533,1199136897,1274406447,1155940152,1876007900,62308769,780006191,174580477,1065976034,60917492,1148091153,1822238312,1279792063,2394388928,236769109,2404388895,2401534552,1043576467,1084443813,1397384139,930081697,2034362233,855533213,1550157301,2410365911,1183218560,1009683250,1479069056,1055061407,1034142459,1776126306,768627758,1043109755,2231234088,1555901602,1487854181,2210447448,1234196568,221134935,779612483,2048417966,190640570,2184731408,594742277,1547326162,1070857520,306804503,182186079,2110404836,1122669470,1281178189,141590080,2130558165,1473902414,100578750,460349390,1615283964,2212431295,605853908,1330257361,669471442,1127480607,1278791524,1087077138,1093603614,1456495330,163749451,1319829084,1041370741,1302242738,2105251860,1478551076,1024114570,1123835148,114749585,1275379491,939261259,128319745,1337360836,750406513,2157041305,1800758596,1322507086,1586278885,944564631,1993057449,1552208426,915563161,1437437796,1129053078,97476529,1870993654,2218063338,1764998535,1855727464,1322602121,673291958,2216664379,1156735193,804061756,124729887,134271887,138458180,9921989,1806980823)  then 'Pro Trader Luxury Handbags & Sneakers'
 when cat.meta_categ_id in (281) and ck.seller_id in (192376191,1193156083,1070085146,1088325962,1706309114,2076849914,108561220,411947125,2217699786,1592686816,1124299881,230389293,314987822,1038378555,1028037130,1906970499,986591370,1000243998,1397020813,1129210695,136955991,1106715478,300222646,1157577152,2153237029,94324923,2221096629,2001384536,2264039823,1153191840,758892726,1178372338,325374982,1120406464,1669034850,1516330637,38557418,1565333127,2295981780,1231362947,1840715311,1088471505,1404586078,1913277462,162432303,1086874666,1241180667,56696976,130067954,1069883169,63019472,1174275765,134304482,57840841,1502881013,2399009731,55636349,146732626,2395107061,38990840,191262728,87217494,2298407919,1010317466,1608916559,193399590,10020303,646712244,2174082402,861998596,2353351128)  then 'Pro Trader Luxury Jewellery & Watches'

when cat.meta_categ_id in (1,220,267,1,64482) and (cat.categ_lvl2_id in (246,63,180250) or cat.categ_lvl3_id in (183454,261332,261328)) then 'Pro Trader Memorabilla'
when cat.meta_categ_id in (550) and cat.categ_lvl2_id in (360,28009) then 'Pro Trader Art, Print & Coins'
when cat.meta_categ_id in (58058) and (cat.categ_lvl2_id in (175672,171957,171961,171961,182094,171485,175673,162497,31530,3676) or cat.categ_lvl3_id in (178893,9355,1245,11195,171485)) and cndtn_rollup_id in (2) then 'Pro Trader Refurbished Technology'
when cat.meta_categ_id in (58058) and (cat.categ_lvl2_id in (175672,171957,171961,171961,182094,171485,175673,162497,31530,3676) or cat.categ_lvl3_id in (178893,9355,1245,11195,171485)) and item_cndtn_id in (1000) then 'Pro Trader New Technology'
when cat.categ_lvl2_id in (261186,617,176985,176984) then 'Pro Trader Media'
when cat.categ_lvl3_id in (32852,14961,14969,11071,15052,260307,43563,20667,71258,42231,45733,42231,38250) and item_cndtn_id in (1500) then 'Pro Trader Consumer Electronics'
when cat.categ_lvl2_id in (48757,260018) then 'Pro Trader Baby Products'
when cat.meta_categ_id in (11450) and cat.categ_lvl2_id in (260012) then 'Pro Trader Men & Womens Fashion'
when cat.meta_categ_id in (11450) and cat.categ_lvl2_id in (260010) then 'Pro Trader Men & Womens Fashion'
when cat.meta_categ_id in (11450) and cat.categ_lvl2_id in (171146) then 'Pro Trader Kids & Specialty Clothing'
when cat.meta_categ_id in (11450) and cat.categ_lvl2_id in (260033) and cat.categ_lvl3_id in (163147,312,175759,3259) then 'Pro Trader Kids & Specialty Clothing'
when cat.meta_categ_id in (888) and cat.categ_lvl2_id in (1513,15273) then 'Pro Trader Sporting Goods'
when cat.meta_categ_id in (26395) and cat.categ_lvl2_id in (180345,11778) then 'Pro Trader Beauty & Medical Products'
when cat.CATEG_LVL3_ID in (170090,170115,170098,102378) then 'Pro Trader Christmas 2022'
when cat.meta_categ_id in (11700,11701) and cat.categ_lvl2_id in (10033,20571,20697,16086) and cat.categ_lvl3_id in (79654,20563,31587,46782,159889,20580,20552,4959,20549,38237,36025,10034,16102,125072,101415,41510,36022,38225,31601,41511,36017,36019,20551,20569,36016,38235,31586,20578,36018,36023,41509,74316,31588,45510,20574,91421,262982,37978,20708,112581,116022,116880,117503,170090)  then 'Pro Trader Home Decor'
when cat.meta_categ_id in (11700) and cat.categ_lvl2_id in (3197) and cat.categ_lvl3_id in (179690,22653,131579,183320,260157,34386,166365,32254,38208,38204,54235,20487,103430,3199,107578,114397,20488,88057,183322,20480,103431,38199,20490,32878,48319,175754,175752,125085,115753) then 'Pro Trader Furniture'
when cat.meta_categ_id in (220) and cat.categ_lvl2_id in (222,233,436,717,767,1039,1082,1188,2562,2613,2616,2624,2631,11731,11743,14737,16486,19169,49019,80546,183446) and cat.categ_lvl3_id in (30,229,230,234,374,437,439,441,719,727,734,736,767,774,776,1036,1039,1082,1189,1197,1522,1628,1633,1634,2518,2529,2537,2540,2543,2550,2574,2576,2594,2595,2600,2615,2624,2646,2662,2663,4779,7111,7317,7319,11732,11733,11734,11735,11736,11737,11739,11742,11744,11745,11746,14737,16479,16515,19001,19017,19019,19024,19180,19181,19183,19186,19187,19188,19205,19214,19854,21254,22150,31398,34054,36275,40852,44001,44005,44012,45361,49020,50296,52338,55415,56363,56366,56367,56369,56370,58799,61113,61114,61116,68386,68387,68394,68410,70109,73252,73257,73260,73262,73263,73265,73266,75725,80546,80547,80551,80553,84912,90922,91594,91596,97093,101767,106605,106631,109232,109247,113040,113041,117210,117211,117212,117213,117214,117215,117216,117217,117218,123844,123850,123851,123852,123853,123854,123859,123860,123871,133709,137885,137891,137894,137897,137902,145845,145860,145867,158746,168247,168248,168818,171127,171138,171145,177918,180023,180268,180269,180273,180274,180275,180276,180277,180278,180350,181055,181056,182181,182187,183447,184588,258040,258041) then 'Pro Trader Toys & Games'
when cat.meta_categ_id in (131090) and cat.categ_lvl2_id in (6030) and cat.categ_lvl3_id in (33549,33612,33726,33637,33687,33605,33579,9886,33559,33694,33542) and cndtn_rollup_id in (1) then 'Pro Trader New Car Parts'
when cat.meta_categ_id in (131090) and cat.categ_lvl2_id in (6030) and cat.categ_lvl3_id in (33549,33612,33726,33637,33687,33605,33579,9886,33559,33694,33542) and cndtn_rollup_id in (3) then 'Pro Trader Used Car Parts'
when cat.meta_categ_id in (131090) and cat.categ_lvl2_id in (38635,34998) and cat.categ_lvl3_id in (179672,169321,171101,169423,138854,185012,139835,96370,14262,183745,179443) then 'Pro Trader In Car Tech, Workshop Equipment, Vehicle Storage'
when cat.meta_categ_id in (131090) and cat.categ_lvl2_id in (107059) and cat.categ_lvl3_id in (107066,180370,133192,175607,133196,171112,133191,133208,180425,173668,180386,173653,133187,133201,107060,180376) then 'Pro Trader Car Tuning & Styling'
when cat.meta_categ_id in (12576) and cat.categ_lvl2_id in (25298,26221) and cat.categ_lvl3_id in (302,1304,11828,19273,25301,25307,25319,26220,26224,31485,50203,50204,57004,61673,92079,109551,184149,184161,184165,184174,184227,260910) then 'Pro Trader Office Supplies & Material Handling'
when cat.meta_categ_id in (11700) and cat.categ_lvl2_id in (299,14308) and cat.categ_lvl3_id in (257942,259345,259621,185035,259338,20620,106121,79631,300,179836,258026,62706,62694) then 'Pro Trader Grocery'


else 'OTHERS' 
end as inventory_prop,

CASE WHEN INVENTORY_PROP LIKE ('Pro Trader%') THEN 'Focused'
WHEN INVENTORY_PROP LIKE ('%Scal%') THEN 'Scaling'
-- WHEN INVENTORY_PROP LIKE ('%Pro Trader%') THEN 'Protrader'
WHEN INVENTORY_PROP LIKE ('%Other%') THEN 'ROnew_vertical'
ELSE 'NA'
END AS FOCUS_FLAG,
case when retail_week = (select retail_week from ACCESS_VIEWS.DW_CAL_DT where age_for_rtl_week_id = -1 group by 1)  then 'current week'
	when retail_week < (select retail_week from ACCESS_VIEWS.DW_CAL_DT where age_for_rtl_week_id = -1 group by 1) then 'Previous week' 
	else 'other'
	end as week_flag,	 
SUM(CK.QUANTITY) AS BI,
SUM(GMV_PLAN_USD) AS GMV
 
FROM  DW_CHECKOUT_TRANS ck 
INNER JOIN ( select CURNCY_ID, CURNCY_PLAN_RATE from  ACCESS_VIEWS.SSA_CURNCY_PLAN_RATE_DIM group by 1,2)AS SSA 
        ON SSA.CURNCY_ID = CK.LSTG_CURNCY_ID     
        
INNER JOIN ( select meta_categ_id, meta_categ_name, CATEG_LVL2_ID, categ_lvl2_name, categ_lvl3_name, categ_lvl3_id,categ_lvl4_id,
LEAF_CATEG_ID,SITE_ID,BSNS_VRTCL_NAME   from ACCESS_VIEWS.DW_CATEGORY_GROUPINGS)  AS CAT
        ON CK.LEAF_CATEG_ID = CAT.LEAF_CATEG_ID
        AND CK.SITE_ID = CAT.SITE_ID

INNER JOIN ( select USEGM_GRP_ID,USEGM_ID,END_DATE,USER_ID,BEG_DATE from DW_USEGM_HIST where 
        USEGM_GRP_ID = 48 
        AND USEGM_ID = 206 
        AND END_DATE >= '2015-12-30' group by 1,2,3,4,5)AS HIST 
        ON HIST.USER_ID = CK.SELLER_ID
        AND CK.CREATED_DT BETWEEN HIST.BEG_DATE AND HIST.END_DATE
		
INNER JOIN ACCESS_VIEWS.DW_CAL_DT AS CAL
        ON CAL.CAL_DT = CK.GMV_DT
        AND CAL.RETAIL_YEAR in (2020,2021, 2022) 
		and age_for_rtl_week_id <= -1 
		and  rtl_qtr_of_rtl_year_id = (select rtl_qtr_of_rtl_year_id from ACCESS_VIEWS.DW_CAL_DT where age_for_rtl_week_id = -1 group by 1)

LEFT JOIN ( select ITEM_ID,CNDTN_ROLLUP_ID, item_cndtn_id  from ACCESS_VIEWS.LSTG_ITEM_CNDTN group by 1,2,3 ) AS CNDTN
        ON CK.ITEM_ID = CNDTN.ITEM_ID

WHERE 1=1
and  SLR_CNTRY_ID = 3 --UK sellers
and  BYR_CNTRY_ID = 3 --UK buyers
and ck.site_id = 3 
AND RPRTD_WACKO_YN = 'N'
        AND AUCT_END_DT >= '2017-12-20'
        AND CREATED_DT >= '2017-12-20'     
    GROUP BY 1,2,3,4,5,6,7) ;