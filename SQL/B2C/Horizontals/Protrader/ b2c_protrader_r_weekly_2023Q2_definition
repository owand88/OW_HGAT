
drop table if exists P_awang_ops_t.Protrader_inventory_prop1;
CREATE TABLE  P_awang_ops_t.Protrader_inventory_prop1 as
SELECT
RETAIL_YEAR
,RETAIL_WEEK
,BSNS_VRTCL_NAME
,NEW_VERTICAl

,case
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Q1 Pro Trader Inv Prop 26/04/23
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- defined first due to overlap
when cat.categ_lvl2_id in (82099, 34998) then 'Pro Trader Car Care & Paints'
when cndtn.item_cndtn_id in (1000) and cat.categ_lvl3_id in (33549,33542,49790,33612,33605,33637,33687,33694,9886,263063,33726) then 'Pro Trader Car Parts New'
when cndtn.item_cndtn_id in (3000, 4000, 5000, 6000, 7000) and cat.categ_lvl3_id in (33549,33542,49790,33612,33605,33637,33687,33694,9886,263063,33726) then 'Pro Trader Car Parts Used'
when cat.categ_lvl3_id in (149372,183447,3394,549,256,4733,45148,253,3410,58533,122493,548) then 'Pro Trader Collectables'
when cat.categ_lvl3_id in (59032,41971,259243,41976,169182,180983,180972,83847,259231,124982,259223,30524,259249,180974,20594,125008,259225,124975,259236,260863,180113) then 'Pro Trader DIY Materials'
when cat.categ_lvl2_id in (238,1202,262353) then 'Pro Trader Dolls & Bears'
when cat.categ_lvl2_id in (29518,177017,25863) then 'Pro Trader Garden Furniture, Structures & Tools'
when cat.categ_lvl2_id in (43554,181003) then 'Pro Trader Garden Tools, Plant care & Hydroponics'
when cat.categ_lvl3_id in (85759,260231,260232,98988,4684,29523,11704,260176,260220,98986,43614,130140,42622) then 'Pro Trader Home DIY'
when (cat.categ_lvl2_id in (258031) or cat.categ_lvl3_id in (79643,101408,79644,175753,20559,20562,20561,20585,103459,45515,260060,103458,175757,20706,112584,260153,20705,136820,20573,175820,91421,262982,36956,260156,20574,175517)) then 'Pro Trader Homewares'
when cat.categ_lvl3_id in (41489,183888,185284,25362,25367,25381) then 'Pro Trader Industrial'
when cat.categ_lvl3_id in (31774,31773,31776,109125,20870,57261,109158,21222,2906,72568,109124,101690,21558) then 'Pro Trader Lifestyle'
when cat.categ_lvl2_id in (4196,91427,10290,262024,260324) and ck.seller_id in (7222799,9716292,16937493,38557418,46985308,57840841,61313340,67298679,72130052,76142059,76665697,78728850,79007920,79668438,80084337,88512547,92771348,94947400,108561220,114802729,124729502,134304482,136955991,140873355,141493342,146101817,146732626,146754174,162432303,182560505,192376191,203214531,203395342,203686273,204116991,206856266,216411815,229018702,230389293,263507813,291975149,300222646,305587902,309915899,317757268,378732229,398982038,411947125,603976790,646712244,687544240,699543905,861998596,885583221,908250719,911717002,925565467,942123067,986591370,1000243998,1001805342,1007389751,1012209316,1014772649,1019252887,1027943353,1028037130,1028798560,1029226521,1038378555,1055736163,1069883169,1070085146,1083584468,1099495376,1101196739,1106715478,1120406464,1124299881,1125508307,1129210695,1150491306,1153191840,1153888847,1157577152,1170524837,1178372338,1178372338,1193156083,1202603417,1231362947,1300826730,1324414974,1331794897,1342109631,1397020813,1401521227,1403555364,1458178587,1516330637,1516330637,1592686816,1687399289,1706309114,1768136482,1813902709,1856738589,1906970499,1960550146,2028348237,2029599502,2041395638,2069566520,2076849914,2153237029,2205340407,2217699786,2221096629,2252210094,2264039823,2275465859,2395107061,2398747326,2399009731,2427110257) then 'Pro Trader Luxury'
when cat.categ_lvl3_id in (41404,101555,1288,64388,249,41396,159943,16215,181254,101554,16216,16214,179015,163896,41459,69965,182110,14985,157158,91384,182111,48460,19699,262426,29946,163862,69967,175833,33021,4713,181221,119544,33034,22966,38072,47067,181220,180009,181219,182150,64604,64606,64602,308,41441,181227,181228,181246,181249,622,38088,181282,16219,1289,181225,4785,38071,168129,123445,261865,178896,3278,119018,113484,15199,38070,23791,177027,47092,47091,177028,119019,69960,177023,177024,132998,29945,170089,81970,30889,177022,12921,181281,623,181267,624) then 'Pro Trader Musical Instruments & DJ Equipment'
when cndtn.item_cndtn_id in (3000,4000,5000,6000,7000) and cat.categ_lvl3_id in (15724, 1059, 3034, 93427, 90928, 90936) and ck.seller_id in (19922481,51428806,58770121,69837543,70747227,110717130,114723918,118270449,122568034,133172134,146753298,163053355,165976697,171010462,174187031,174580477,181204378,201980597,224245007,241990616,264487912,272097653,274511365,296262500,301174790,303207363,308401320,360947245,368116317,521509515,525905171,527531544,700163386,736332639,749175138,762394906,777793305,779264772,807642762,824476637,855027691,998100001,1010876942,1019112640,1049648857,1052765862,1054050856,1054605193,1101468322,1102914179,1107610019,1109310045,1117778039,1118759008,1124244969,1127913192,1135196631,1149197339,1154448092,1158417087,1162019618,1173940257,1190116112,1199345580,1244051367,1244421056,1266650395,1292158237,1376295881,1444366098,1459729310,1462745417,1481029070,1486978040,1498465304,1529479834,1530707885,1548729797,1584793300,1595095558,1619072766,1633848174,1641958463,1677911292,1691204951,1702249182,1748473498,1768524180,1785436135,1786633373,1815050335,1867047070,1876402038,1891970143,1910962638,1935428792,1952826606,1986067678,1994217038,2013107160,2039734273,2062038403,2066900090,2100841479,2144897968,2193199417,2211840506,2216063141,2217244737,2226540837,2226943415,2248634063,2250088604,2270705212,2271030904,2296497745,2302051266,2312200286,2359326813,2378990404,2379034884,2379316941,2430742812) then 'Pro Trader Preloved Fashion'
when cat.categ_lvl3_id in (52536,260017,1059,93427,15724,3034,169291,163147,3259) then 'Pro Trader Seasonal Fashion'
when (cat.categ_lvl2_id in (113,45077) or cat.categ_lvl3_id in (3094,28141,183205,28147,183209,183231,183233,36589,183253,183265,183270,183274,183281,183286,147840,3115,180930,83965,180929,3118,28174,28172)) then 'Pro Trader Sewing & Needlework'
when cat.categ_lvl3_id in (166325,22656,122772,38223,20621,43506,43504,159898,159897,122954,40620,36024,43503) then 'Pro Trader Storage'
when (cat.categ_lvl2_id in (20727,42154,149242) or cat.categ_lvl3_id in (2034,10025,20512,20513,29511,29514,31587,43533,43536,75593,75601,115772,118863,260926)) then 'Pro Trader Swimming & Outdoor Heating/ Cooking/Dining'
when cndtn.item_cndtn_id in (1000,1500) and cat.categ_lvl3_id in (3271,4786,4787,11071,11725,14970,14971,14981,14990,15053,15054,15056,20667,22610,22635,38250,42231,43563,45733,48626,48645,48647,48655,56169,71258,71583,71584,72406,73839,81741,96954,109256,111694,112529,163769,163829,175708,175711,184618,260307,260318) then 'Pro Trader Technology - New & Open Box - Appliances'
when cndtn.item_cndtn_id in (1000,1500) and cat.categ_lvl2_id in (9355,139971,139973,162497,171957,171961,175672,175673,178893) then 'Pro Trader Technology - New & Open Box Hard Tech'
when cndtn.item_cndtn_id in (2000,2010,2020,2030) and cat.categ_lvl2_id in (3676,9355,31530,162497,171485,171957,171961,175672,175673,178893,182094) then 'Pro Trader Technology - Refurb'

else 'OTHERS' end as inventory_prop

,CASE WHEN INVENTORY_PROP LIKE ('Pro Trader%') THEN 'Focused'
	WHEN INVENTORY_PROP LIKE ('%Scal%') THEN 'Scaling'
	-- WHEN INVENTORY_PROP LIKE ('%Pro Trader%') THEN 'Protrader'
	WHEN INVENTORY_PROP LIKE ('%Other%') THEN 'ROnew_vertical'
	ELSE 'NA'
	END AS FOCUS_FLAG
,case when retail_week = (select retail_week from ACCESS_VIEWS.DW_CAL_DT where age_for_rtl_week_id = -1 group by 1)  then 'current week'
	when retail_week < (select retail_week from ACCESS_VIEWS.DW_CAL_DT where age_for_rtl_week_id = -1 group by 1) then 'Previous week' 
	else 'other'
	end as week_flag	 
,SUM(CK.QUANTITY) AS BI
,SUM(GMV_PLAN_USD) AS GMV
 
FROM ACCESS_VIEWS.DW_CHECKOUT_TRANS ck 
INNER JOIN ( select distinct CURNCY_ID, CURNCY_PLAN_RATE from  ACCESS_VIEWS.SSA_CURNCY_PLAN_RATE_DIM ) AS SSA 
        ON SSA.CURNCY_ID = CK.LSTG_CURNCY_ID     
        
INNER JOIN P_INVENTORYPLANNING_T.DW_CATEGORY_GROUPINGS_ADJ CAT
        ON CK.LEAF_CATEG_ID = CAT.LEAF_CATEG_ID
        AND CK.SITE_ID = CAT.SITE_ID

INNER JOIN ( select USEGM_GRP_ID,USEGM_ID,END_DATE,USER_ID,BEG_DATE from DW_USEGM_HIST where 
        USEGM_GRP_ID = 48 
        AND USEGM_ID = 206 
        AND END_DATE >= '2015-12-30' group by 1,2,3,4,5)AS HIST 
        ON HIST.USER_ID = CK.SELLER_ID
        AND CK.CREATED_DT BETWEEN HIST.BEG_DATE AND HIST.END_DATE
		
INNER JOIN ACCESS_VIEWS.DW_CAL_DT AS CAL
        ON CAL.CAL_DT = CK.GMV_DT
        AND CAL.AGE_FOR_RTL_YEAR_ID >= -2
		and age_for_rtl_week_id <= -1 
		and  rtl_qtr_of_rtl_year_id = (select rtl_qtr_of_rtl_year_id from ACCESS_VIEWS.DW_CAL_DT where age_for_rtl_week_id = -1 group by 1)

LEFT JOIN ( select ITEM_ID,CNDTN_ROLLUP_ID, item_cndtn_id  from ACCESS_VIEWS.LSTG_ITEM_CNDTN group by 1,2,3 ) AS CNDTN
        ON CK.ITEM_ID = CNDTN.ITEM_ID

WHERE 1=1
and  SLR_CNTRY_ID = 3 --UK sellers
and  BYR_CNTRY_ID = 3 --UK buyers
and ck.site_id = 3 
AND RPRTD_WACKO_YN = 'N'
        AND AUCT_END_DT >= '2017-12-20'
        AND CREATED_DT >= '2017-12-20'     
    GROUP BY 1,2,3,4,5,6,7
	;